<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>JustGo ì¼ì • ìƒì„±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="./style.css">
  <style>
    .schedule-card{background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:12px;margin:10px 0;cursor:pointer}
    .schedule-summary{font-weight:700;margin-bottom:6px}
    .schedule-detail{display:none;color:#333;font-size:14px;line-height:1.6}
    .schedule-card.expanded .schedule-detail{display:block}
    .btn{border:1px solid #0055ff;padding:10px 14px;border-radius:10px;background:#eef3ff;cursor:pointer}
  </style>
</head>
<body>
  <main style="max-width:680px;margin:24px auto;padding:0 16px;">
    <h1>ğŸŒ JustGo ì¼ì • ìƒì„±</h1>

    <section style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
      <label>ì—¬í–‰ì§€
        <input id="dest" placeholder="ì˜ˆ: ê°•ë¦‰" style="width:100%;padding:8px">
      </label>
      <label>ì—¬í–‰ ì‹œì‘ì¼
        <input id="start" type="date" style="width:100%;padding:8px">
      </label>
      <label>ì—¬í–‰ ì¢…ë£Œì¼
        <input id="end" type="date" style="width:100%;padding:8px">
      </label>
      <label>ì˜ˆì‚°(ì›)
        <input id="budget" type="number" value="300000" step="10000" style="width:100%;padding:8px">
      </label>
      <label>ìŠ¤íƒ€ì¼
        <select id="style" style="width:100%;padding:8px">
          <option>íœ´ì‹ ì¤‘ì‹¬</option>
          <option>ì•¡í‹°ë¹„í‹° ì¤‘ì‹¬</option>
          <option selected>ë§›ì§‘ íƒë°©</option>
          <option>ì—­ì‚¬ íƒë°©</option>
        </select>
      </label>
      <label>ë™ë°˜ì(ì‰¼í‘œë¡œ êµ¬ë¶„)
        <input id="companions" placeholder="ì˜ˆ: ì¹œêµ¬, ê°€ì¡±" style="width:100%;padding:8px">
      </label>
      <label style="grid-column:1 / -1">ê°€ê³  ì‹¶ì€ ì¥ì†Œ(ì‰¼í‘œë¡œ êµ¬ë¶„)
        <input id="selPlaces" placeholder="ì˜ˆ: ë¶ˆêµ­ì‚¬, í™©ë¦¬ë‹¨ê¸¸" style="width:100%;padding:8px">
      </label>
    </section>

    <div style="margin:16px 0;">
      <button id="sendPlanBtn" class="btn">ì¼ì • ìƒì„±í•˜ê¸°</button>
    </div>

    <section id="planResult"></section>
  </main>

  <script type="module">
    import { apiPlan } from "./js/api.js";

    const $btn = document.getElementById("sendPlanBtn");
    const $out = document.getElementById("planResult");

    function diffDays(s, e){
      const sd=new Date(s), ed=new Date(e);
      return Math.round((ed - sd)/(1000*60*60*24)) + 1;
    }

    function renderSchedules(data){
      const html = (data.schedules || []).map((s,i)=>`
        <div class="schedule-card">
          <div class="schedule-summary">ğŸ—“ï¸ ${s.title || ("ì¼ì • ì¶”ì²œ " + (i+1))}</div>
          <div class="schedule-detail">${(s.detail||"").replace(/\n/g,"<br>")}</div>
        </div>
      `).join("") || `<div>ê²°ê³¼ê°€ ë¹„ì–´ìˆì–´ìš”.</div>`;
      $out.innerHTML = html;

      // ì¹´ë“œ í† ê¸€ + ë”ë¸”í´ë¦­ ì‹œ justgomap ì´ë™ ë“± í™•ì¥ ê°€ëŠ¥
      document.querySelectorAll(".schedule-card").forEach(card=>{
        let expanded=false;
        card.addEventListener("click", ()=>{ expanded=!expanded; card.classList.toggle("expanded", expanded); });
      });
    }

    $btn?.addEventListener("click", async ()=>{
      try{
        $btn.disabled = true;
        const dest = document.getElementById("dest").value.trim();
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;
        const style = document.getElementById("style").value;
        const companions = document.getElementById("companions").value.split(",").map(s=>s.trim()).filter(Boolean);
        const budget = Number(document.getElementById("budget").value || 0);
        const selected_places = document.getElementById("selPlaces").value.split(",").map(s=>s.trim()).filter(Boolean);

        if(!dest || !start || !end){ alert("ì—¬í–‰ì§€/ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
        const days = diffDays(start, end);
        if(days < 1){ alert("ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ê³¼ ê°™ê±°ë‚˜ ì´í›„ì—¬ì•¼ í•´ìš”."); return; }

        const data = await apiPlan({ location: dest, days, style, companions, budget, selected_places, travel_date: start, count: 3 });
        // base_point ì €ì¥ â†’ ì´í›„ ì¶”ì²œì—ì„œ ì‚¬ìš©
        localStorage.setItem("lastBasePoint", JSON.stringify(data.base_point));
        localStorage.setItem("selectedLocation", dest);
        localStorage.setItem("selectedDates", JSON.stringify([start, end]));

        renderSchedules(data);
      }catch(err){
        console.error(err);
        $out.innerHTML = `<div style="color:#c00;">ìš”ì²­ ì‹¤íŒ¨: ${err.message}</div>`;
      }finally{
        $btn.disabled = false;
      }
    });
  </script>
</body>
</html>
