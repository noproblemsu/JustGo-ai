<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>추천 일정</title>
  <style>
    :root {
      --primary: #0059ff;
      --text: #000;
      --muted: #666;
      --bg: #f7f7f8;
      --panel: #ffffff;
      --border: #e6e6e6;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, "Apple SD Gothic Neo", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
    .page { max-width: 860px; margin: 0 auto; padding: 16px; }
    .title { display:flex; align-items:center; gap:8px; font-size:22px; font-weight:700; }
    .subtitle { color: var(--muted); margin: 6px 0 4px; }
    .notice { color: var(--muted); margin-bottom: 16px; }
    .error { color:#c00; margin:10px 0; }
    .list { display:flex; flex-direction:column; gap:12px; }

    /* 카드 스타일 (JS에서 itinerary-option을 사용) */
    .itinerary-option {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.05);
      transition: transform .06s ease, box-shadow .12s ease, background .15s ease;
    }
    .itinerary-option:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.08); background:#fdfdff; }
    .card-title { font-weight:700; }
    .card-sub { margin-top:6px; color: var(--muted); font-size: 14px; white-space: pre-line; }

    .chat { margin-top:18px; background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; display:none; }
    .chat-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .chat-title { font-weight:700; }
    .chat-close { border:none; background:#f2f4f7; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .chat-log { height: 260px; overflow-y:auto; padding:8px; border:1px solid var(--border); border-radius:10px; background:#fafafa; }
    .msg { margin:10px 0; display:flex; }
    .msg .bubble { max-width:80%; padding:10px 12px; border-radius:14px; line-height:1.4; }
    .msg.me { justify-content:flex-end; }
    .msg.me .bubble { background:#dbeafe; }
    .msg.bot { justify-content:flex-start; }
    .msg.bot .bubble { background:#efefef; }
    .chat-input { display:flex; gap:8px; margin-top:10px; }
    .chat-input input { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; font-size:15px; }
    .chat-input button { background: var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
    @media (max-width: 420px) { .chat-log { height: 220px; } }
  </style>
</head>
<body>
  <div class="page">
    <div class="title">📅 추천 일정</div>
    <div id="subtitle" class="subtitle"></div>
    <div id="notice" class="notice">카드를 클릭하면 채팅창이 펼쳐져요.</div>
    <div id="error" class="error" style="display:none;"></div>

    <!-- 카드 리스트 -->
    <div id="itinerary-list" class="list"></div>

    <!-- 채팅 -->
    <div id="chat" class="chat">
      <div class="chat-header">
        <div class="chat-title" id="chat-title">일정 대화</div>
        <button class="chat-close" id="chat-close">닫기</button>
      </div>
      <div id="chat-log" class="chat-log"></div>
      <div class="chat-input">
        <input id="chat-input" type="text" placeholder="메시지를 입력하세요 (예: 2일차 저녁을 더 가볍게)" />
        <button id="chat-send">전송</button>
      </div>
    </div>
  </div>

<script>
  // ===== 설정 =====
  const API_PLAN = "http://127.0.0.1:8000/api/plan";
  const CHAT_ENDPOINT = "http://127.0.0.1:8000/api/chat";

  // ===== 도우미 =====
  const $ = (s) => document.querySelector(s);
  function el(tag, cls, txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e; }
  function addMsg(role, text){
    const log = $("#chat-log");
    const row = el("div", `msg ${role}`);
    row.appendChild(el("div", "bubble", text));
    log.appendChild(row); log.scrollTop = log.scrollHeight;
  }
  // 안전 JSON 파서
  function safeJSON(key, fallback){
    try{
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    }catch{ return fallback; }
  }
  // 항상 카드가 보이게 하는 로컬 폴백
function showFallback(){
    console.warn("[plan] using local fallback");
    itineraries = [
      { title:"일정추천 1 샘플", body:"(세부 내용 없음)", fullText:"일정추천 1 샘플\n---\n(세부 내용 없음)" },
    
    ];
    renderCards();
    try{
      let warn = document.querySelector("#backend-warning");
      if (!warn) {
        warn = document.createElement("div");
        warn.id = "backend-warning";
        warn.className = "subtitle";
        warn.style.color = "crimson";
        warn.textContent = "(백엔드 사용 불가 또는 빈 응답) 로컬 데이터로 표시합니다.";
        document.querySelector("#subtitle").insertAdjacentElement("afterend", warn);
      }
    }catch(e){}
  }

  // ===== 상태 =====
  let itineraries = [];     // 각 일정: {title, body, fullText}
  let selectedIndex = null; // 선택된 카드 인덱스
  let currentBudget = 300000;

  // ===== 일정 그리기 =====
  function renderCards(){
    const list = $("#itinerary-list");
    list.innerHTML = "";

    itineraries.forEach((it, i) => {
      const card = el("div", "itinerary-option");
      card.dataset.index = String(i);

      const title = el("div", "card-title", it.title || `일정추천 ${i+1}`);

      const bodyText = (typeof it.body === "string") ? it.body : "";
      const sub   = el(
        "div",
        "card-sub",
        bodyText.length > 160 ? bodyText.slice(0,160) + "…" : (bodyText || "(세부 내용 없음)")
      );

      const details = el("pre", "details");
      details.style.whiteSpace = "pre-wrap";
      details.style.display = "none";
      details.textContent = (typeof it.fullText === "string") ? it.fullText : (title.textContent + "\n---\n" + bodyText);

      const toggle = el("div", "trip-line", "전체 일정 펼치기 ▾");
      toggle.style.cursor = "pointer";
      toggle.onclick = (e)=>{
        e.stopPropagation();
        const vis = details.style.display === "block";
        details.style.display = vis ? "none" : "block";
        toggle.textContent = vis ? "전체 일정 펼치기 ▾" : "전체 일정 접기 ▴";
      };

      card.appendChild(title);
      card.appendChild(sub);
      card.appendChild(toggle);
      card.appendChild(details);
      list.appendChild(card);
    });
  }

  // ===== 초기 로딩: 백엔드에서 일정 받아오기 =====
  async function boot(){
    try {
      // 설문값(안전 파서 사용)
      const location = localStorage.getItem("selectedLocation") || "경주";
      const days = 3;
      const style = "친구와/체험/액티비티";
      const companions = safeJSON("selectedCompanions", ["친구"]);
      currentBudget = Number(localStorage.getItem("budget") || "300000");
      const selectedDates = safeJSON("selectedDates", ["2025-08-13", "2025-08-15"]);
      const travel_date = selectedDates[0] || "2025-08-13";

      // 상단 정보
      const endDate = new Date(new Date(travel_date).getTime() + (days-1)*86400000).toISOString().slice(0,10);
      $("#subtitle").innerText = `${location} · ${travel_date} ~ ${endDate} · 예산 ${currentBudget.toLocaleString()}원 · 스타일 ${style}`;

      // 서버 호출
      try {
        const res = await fetch(API_PLAN, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            location, days, style,
            companions, budget: currentBudget,
            selected_places: [],
            travel_date,
            count: 1
          })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        let list = Array.isArray(data.schedules) ? data.schedules : [];
        if (list.length === 0) {
          console.warn("[plan] schedules empty. Using local fallback.");
          return showFallback();
        }

        // 기존에 혹시 있었던 .slice(0,3) 제거!
      itineraries = (Array.isArray(data.schedules) ? data.schedules : []).map(s => {
        const title = (s.title || "일정추천").split("\n")[0].trim();
        const body = (s.detail || "").trim();
        const fullText = `${title}\n---\n${body}`;
        return { title, body, fullText };
      });


        renderCards();
        $("#backend-warning")?.remove();

      } catch (err) {
        console.error("[plan] fetch/parse error:", err);
        showFallback();
      }
    } catch (fatal) {
      // boot의 상단(로컬 스토리지 파싱 등)에서 난 에러도 모두 폴백으로 처리
      console.error("[boot] fatal:", fatal);
      showFallback();
    }
  }

  // ===== 카드 클릭 → 채팅 열기 =====
  document.addEventListener("click", (e)=>{
    const card = e.target.closest(".itinerary-option");
    if(!card) return;
    selectedIndex = Number(card.dataset.index);
    const it = itineraries[selectedIndex];
    $("#chat-title").textContent = `💬 ${it.title} 대화`;
    $("#chat").style.display = "block";
    $("#chat-log").innerHTML = "";
    addMsg("bot", `"${it.title}" 일정에 대해 무엇을 바꾸고 싶나요?\n예) 2일차 저녁을 더 가볍게, 이동 동선을 더 짧게 등`);
  });

  // 닫기
  document.addEventListener("click", (e)=>{
    if(e.target.id === "chat-close"){
      $("#chat").style.display = "none"; selectedIndex = null;
    }
  });

  // 전송
  $("#chat-send").addEventListener("click", sendMessage);
  $("#chat-input").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendMessage(); });

  async function sendMessage(){
    const input = $("#chat-input");
    const msg = input.value.trim();
    if(!msg || selectedIndex==null) return;
    addMsg("me", msg); input.value = "";

    const it = itineraries[selectedIndex];

    try{
      const res = await fetch(CHAT_ENDPOINT, {
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          message: msg,
          itineraryIndex: selectedIndex,
          itineraryText: it.fullText,           // 전체 텍스트 전달
          context: { budget: currentBudget }
        })
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json(); // { reply, updatedItinerary? }
      addMsg("bot", data.reply || "수정했습니다.");

      if(data.updatedItinerary && typeof data.updatedItinerary === "string"){
        const lines = data.updatedItinerary.split(/\r?\n/);
        const newTitle = (lines[0] || it.title).trim();
        const body = lines.slice(2).join("\n").trim();
        const fullText = data.updatedItinerary.trim();
        itineraries[selectedIndex] = { title: newTitle, body, fullText };
        renderCards();
        $("#chat-title").textContent = `💬 ${newTitle} 대화`;
      }
    }catch(err){
      addMsg("bot", `(임시) "${msg}" 요청을 반영했습니다. (백엔드 오류/연결 문제)`);
    }
  }

  document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
