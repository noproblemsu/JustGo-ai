<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¶”ì²œ ì¼ì •</title>
  <style>
    :root {
      --primary: #0059ff;
      --text: #000;
      --muted: #666;
      --bg: #f7f7f8;
      --panel: #ffffff;
      --border: #e6e6e6;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, "Apple SD Gothic Neo", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); }
    .page { max-width: 860px; margin: 0 auto; padding: 16px; }
    .title { display:flex; align-items:center; gap:8px; font-size:22px; font-weight:700; }
    .subtitle { color: var(--muted); margin: 6px 0 4px; }
    .notice { color: var(--muted); margin-bottom: 16px; }
    .error { color:#c00; margin:10px 0; }
    .list { display:flex; flex-direction:column; gap:12px; }

    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ (JSì—ì„œ itinerary-optionì„ ì‚¬ìš©) */
    .itinerary-option {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,.05);
      transition: transform .06s ease, box-shadow .12s ease, background .15s ease;
    }
    .itinerary-option:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.08); background:#fdfdff; }
    .card-title { font-weight:700; }
    .card-sub { margin-top:6px; color: var(--muted); font-size: 14px; white-space: pre-line; }

    .chat { margin-top:18px; background: var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; display:none; }
    .chat-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .chat-title { font-weight:700; }
    .chat-close { border:none; background:#f2f4f7; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .chat-log { height: 260px; overflow-y:auto; padding:8px; border:1px solid var(--border); border-radius:10px; background:#fafafa; }
    .msg { margin:10px 0; display:flex; }
    .msg .bubble { max-width:80%; padding:10px 12px; border-radius:14px; line-height:1.4; }
    .msg.me { justify-content:flex-end; }
    .msg.me .bubble { background:#dbeafe; }
    .msg.bot { justify-content:flex-start; }
    .msg.bot .bubble { background:#efefef; }
    .chat-input { display:flex; gap:8px; margin-top:10px; }
    .chat-input input { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; font-size:15px; }
    .chat-input button { background: var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
    @media (max-width: 420px) { .chat-log { height: 220px; } }
  </style>
</head>
<body>
  <div class="page">
    <div class="title">ğŸ“… ì¶”ì²œ ì¼ì •</div>
    <div id="subtitle" class="subtitle"></div>
    <div id="notice" class="notice">ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì±„íŒ…ì°½ì´ í¼ì³ì ¸ìš”.</div>
    <div id="error" class="error" style="display:none;"></div>

    <!-- ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
    <div id="itinerary-list" class="list"></div>

    <!-- ì±„íŒ… -->
    <div id="chat" class="chat">
      <div class="chat-header">
        <div class="chat-title" id="chat-title">ì¼ì • ëŒ€í™”</div>
        <button class="chat-close" id="chat-close">ë‹«ê¸°</button>
      </div>
      <div id="chat-log" class="chat-log"></div>
      <div class="chat-input">
        <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ)" />
        <button id="chat-send">ì „ì†¡</button>
      </div>
    </div>
  </div>

<script>
  // ===== ì„¤ì • =====
  const API_PLAN = "http://127.0.0.1:8000/api/plan";
  const CHAT_ENDPOINT = "http://127.0.0.1:8000/api/chat";

  // ===== ë„ìš°ë¯¸ =====
  const $ = (s) => document.querySelector(s);
  function el(tag, cls, txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e; }
  function addMsg(role, text){
    const log = $("#chat-log");
    const row = el("div", `msg ${role}`);
    row.appendChild(el("div", "bubble", text));
    log.appendChild(row); log.scrollTop = log.scrollHeight;
  }
  // ì•ˆì „ JSON íŒŒì„œ
  function safeJSON(key, fallback){
    try{
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    }catch{ return fallback; }
  }
  // í•­ìƒ ì¹´ë“œê°€ ë³´ì´ê²Œ í•˜ëŠ” ë¡œì»¬ í´ë°±
function showFallback(){
    console.warn("[plan] using local fallback");
    itineraries = [
      { title:"ì¼ì •ì¶”ì²œ 1 ìƒ˜í”Œ", body:"(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)", fullText:"ì¼ì •ì¶”ì²œ 1 ìƒ˜í”Œ\n---\n(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)" },
    
    ];
    renderCards();
    try{
      let warn = document.querySelector("#backend-warning");
      if (!warn) {
        warn = document.createElement("div");
        warn.id = "backend-warning";
        warn.className = "subtitle";
        warn.style.color = "crimson";
        warn.textContent = "(ë°±ì—”ë“œ ì‚¬ìš© ë¶ˆê°€ ë˜ëŠ” ë¹ˆ ì‘ë‹µ) ë¡œì»¬ ë°ì´í„°ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.";
        document.querySelector("#subtitle").insertAdjacentElement("afterend", warn);
      }
    }catch(e){}
  }

  // ===== ìƒíƒœ =====
  let itineraries = [];     // ê° ì¼ì •: {title, body, fullText}
  let selectedIndex = null; // ì„ íƒëœ ì¹´ë“œ ì¸ë±ìŠ¤
  let currentBudget = 300000;

  // ===== ì¼ì • ê·¸ë¦¬ê¸° =====
  function renderCards(){
    const list = $("#itinerary-list");
    list.innerHTML = "";

    itineraries.forEach((it, i) => {
      const card = el("div", "itinerary-option");
      card.dataset.index = String(i);

      const title = el("div", "card-title", it.title || `ì¼ì •ì¶”ì²œ ${i+1}`);

      const bodyText = (typeof it.body === "string") ? it.body : "";
      const sub   = el(
        "div",
        "card-sub",
        bodyText.length > 160 ? bodyText.slice(0,160) + "â€¦" : (bodyText || "(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)")
      );

      const details = el("pre", "details");
      details.style.whiteSpace = "pre-wrap";
      details.style.display = "none";
      details.textContent = (typeof it.fullText === "string") ? it.fullText : (title.textContent + "\n---\n" + bodyText);

      const toggle = el("div", "trip-line", "ì „ì²´ ì¼ì • í¼ì¹˜ê¸° â–¾");
      toggle.style.cursor = "pointer";
      toggle.onclick = (e)=>{
        e.stopPropagation();
        const vis = details.style.display === "block";
        details.style.display = vis ? "none" : "block";
        toggle.textContent = vis ? "ì „ì²´ ì¼ì • í¼ì¹˜ê¸° â–¾" : "ì „ì²´ ì¼ì • ì ‘ê¸° â–´";
      };

      card.appendChild(title);
      card.appendChild(sub);
      card.appendChild(toggle);
      card.appendChild(details);
      list.appendChild(card);
    });
  }

  // ===== ì´ˆê¸° ë¡œë”©: ë°±ì—”ë“œì—ì„œ ì¼ì • ë°›ì•„ì˜¤ê¸° =====
  async function boot(){
    try {
      // ì„¤ë¬¸ê°’(ì•ˆì „ íŒŒì„œ ì‚¬ìš©)
      const location = localStorage.getItem("selectedLocation") || "ê²½ì£¼";
      const days = 3;
      const style = "ì¹œêµ¬ì™€/ì²´í—˜/ì•¡í‹°ë¹„í‹°";
      const companions = safeJSON("selectedCompanions", ["ì¹œêµ¬"]);
      currentBudget = Number(localStorage.getItem("budget") || "300000");
      const selectedDates = safeJSON("selectedDates", ["2025-08-13", "2025-08-15"]);
      const travel_date = selectedDates[0] || "2025-08-13";

      // ìƒë‹¨ ì •ë³´
      const endDate = new Date(new Date(travel_date).getTime() + (days-1)*86400000).toISOString().slice(0,10);
      $("#subtitle").innerText = `${location} Â· ${travel_date} ~ ${endDate} Â· ì˜ˆì‚° ${currentBudget.toLocaleString()}ì› Â· ìŠ¤íƒ€ì¼ ${style}`;

      // ì„œë²„ í˜¸ì¶œ
      try {
        const res = await fetch(API_PLAN, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            location, days, style,
            companions, budget: currentBudget,
            selected_places: [],
            travel_date,
            count: 1
          })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        let list = Array.isArray(data.schedules) ? data.schedules : [];
        if (list.length === 0) {
          console.warn("[plan] schedules empty. Using local fallback.");
          return showFallback();
        }

        // ê¸°ì¡´ì— í˜¹ì‹œ ìˆì—ˆë˜ .slice(0,3) ì œê±°!
      itineraries = (Array.isArray(data.schedules) ? data.schedules : []).map(s => {
        const title = (s.title || "ì¼ì •ì¶”ì²œ").split("\n")[0].trim();
        const body = (s.detail || "").trim();
        const fullText = `${title}\n---\n${body}`;
        return { title, body, fullText };
      });


        renderCards();
        $("#backend-warning")?.remove();

      } catch (err) {
        console.error("[plan] fetch/parse error:", err);
        showFallback();
      }
    } catch (fatal) {
      // bootì˜ ìƒë‹¨(ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ íŒŒì‹± ë“±)ì—ì„œ ë‚œ ì—ëŸ¬ë„ ëª¨ë‘ í´ë°±ìœ¼ë¡œ ì²˜ë¦¬
      console.error("[boot] fatal:", fatal);
      showFallback();
    }
  }

  // ===== ì¹´ë“œ í´ë¦­ â†’ ì±„íŒ… ì—´ê¸° =====
  document.addEventListener("click", (e)=>{
    const card = e.target.closest(".itinerary-option");
    if(!card) return;
    selectedIndex = Number(card.dataset.index);
    const it = itineraries[selectedIndex];
    $("#chat-title").textContent = `ğŸ’¬ ${it.title} ëŒ€í™”`;
    $("#chat").style.display = "block";
    $("#chat-log").innerHTML = "";
    addMsg("bot", `"${it.title}" ì¼ì •ì— ëŒ€í•´ ë¬´ì—‡ì„ ë°”ê¾¸ê³  ì‹¶ë‚˜ìš”?\nì˜ˆ) 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ, ì´ë™ ë™ì„ ì„ ë” ì§§ê²Œ ë“±`);
  });

  // ë‹«ê¸°
  document.addEventListener("click", (e)=>{
    if(e.target.id === "chat-close"){
      $("#chat").style.display = "none"; selectedIndex = null;
    }
  });

  // ì „ì†¡
  $("#chat-send").addEventListener("click", sendMessage);
  $("#chat-input").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendMessage(); });

  async function sendMessage(){
    const input = $("#chat-input");
    const msg = input.value.trim();
    if(!msg || selectedIndex==null) return;
    addMsg("me", msg); input.value = "";

    const it = itineraries[selectedIndex];

    try{
      const res = await fetch(CHAT_ENDPOINT, {
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          message: msg,
          itineraryIndex: selectedIndex,
          itineraryText: it.fullText,           // ì „ì²´ í…ìŠ¤íŠ¸ ì „ë‹¬
          context: { budget: currentBudget }
        })
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json(); // { reply, updatedItinerary? }
      addMsg("bot", data.reply || "ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.");

      if(data.updatedItinerary && typeof data.updatedItinerary === "string"){
        const lines = data.updatedItinerary.split(/\r?\n/);
        const newTitle = (lines[0] || it.title).trim();
        const body = lines.slice(2).join("\n").trim();
        const fullText = data.updatedItinerary.trim();
        itineraries[selectedIndex] = { title: newTitle, body, fullText };
        renderCards();
        $("#chat-title").textContent = `ğŸ’¬ ${newTitle} ëŒ€í™”`;
      }
    }catch(err){
      addMsg("bot", `(ì„ì‹œ) "${msg}" ìš”ì²­ì„ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤. (ë°±ì—”ë“œ ì˜¤ë¥˜/ì—°ê²° ë¬¸ì œ)`);
    }
  }

  document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
