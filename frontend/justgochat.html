<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>ì¶”ì²œ ì¼ì •</title>
  <style>
    :root{
      --primary-blue:#0059ff;
      --border-blue:#0055ff;
      --text-dark:#000;
      --text-light:#fff;
      --bg-white:#fff;
      --bg:#f0f0f0;
      --border:#e7eaf0;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:Inter,"Istok Web","Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg); color:var(--text-dark);
    }
    .page-wrap{ max-width:390px; min-height:100dvh; margin:0 auto; background:var(--bg-white); display:flex; flex-direction:column; overflow:hidden; }

    .app-header{ background-color:#0059ff; height:66px; display:flex; justify-content:flex-end; align-items:center; padding:11px 16px; }
    .home-icon{ width:30px; height:30px; display:block; }

    .content{ flex:1; overflow:auto; background:#fafafa; }
    .hero{ padding:14px 16px 6px; background:#fafafa; border-bottom:1px solid var(--border); }
    .title{ margin:0 0 6px; font-size:18px; font-weight:800; }
    .subtitle{ color:#555; margin:2px 0; font-size:13px; }
    .notice{ color:#6b7280; margin:4px 0 10px; font-size:12px; }
    .error{ color:#c62828; margin:8px 0; font-size:13px; display:none; }

    .list{ display:flex; flex-direction:column; gap:12px; padding:10px 16px 20px; }
    .itinerary-option{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px 14px; cursor:pointer; transition:transform .08s, box-shadow .15s, border-color .15s; box-shadow:0 2px 6px rgba(0,0,0,.04); }
    .itinerary-option:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.08); border-color:#dbe2ff; }
    .card-title{ font-weight:800; font-size:15px; color:#111; }
    .card-sub{ margin-top:6px; color:#333; font-size:13px; white-space:pre-line; }
    .trip-line{ margin-top:8px; font-size:12px; color:#4b5563; user-select:none; }
    .details{ margin-top:8px; border-top:1px dashed #e6eaf2; padding-top:8px; font-size:12.5px; color:#374151; background:#fff; }

    .chat{ position:sticky; bottom:0; background:#fff; border-top:1px solid var(--border); box-shadow:0 -6px 20px rgba(0,0,0,.08); border-top-left-radius:16px; border-top-right-radius:16px; padding:10px 12px 12px; margin-top:2px; display:none; }
    .chat-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; gap:8px; }
    .chat-title{ font-weight:800; font-size:14px; }
    .mode-tabs{ display:flex; gap:6px; }
    .mode-tabs button{ border:1px solid var(--border-blue); background:#f7f8ff; color:#234; padding:6px 10px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:700; }
    .mode-tabs button.active{ background:var(--primary-blue); color:#fff; }
    .chat-close{ border:none; background:#eef2ff; color:#234; padding:6px 10px; border-radius:10px; cursor:pointer; }
    .chat-log{ height:260px; overflow:auto; padding:10px; border:1px solid var(--border); border-radius:12px; background:#fafafa; }
    .msg{ margin:8px 0; display:flex; align-items:flex-end; }
    .msg .bubble{ max-width:78%; padding:9px 12px; border-radius:14px; line-height:1.45; font-size:14px; word-break:break-word; box-shadow:0 1px 2px rgba(0,0,0,.06); }
    .msg.me{ justify-content:flex-end; }
    .msg.me .bubble{ background:var(--primary-blue); color:#fff; border-top-right-radius:4px; }
    .msg.bot{ justify-content:flex-start; }
    .msg.bot .bubble{ background:#eee; color:#111; border-top-left-radius:4px; }
    .chat-input{ display:flex; gap:8px; margin-top:10px; }
    .chat-input input{ flex:1; padding:12px; border:1.5px solid var(--border-blue); background:#f7f8ff; border-radius:14px; outline:none; font-size:14px; }
    .chat-input button{ background:var(--primary-blue); color:#fff; border:none; padding:12px 14px; border-radius:14px; cursor:pointer; font-weight:700; box-shadow:0 2px 8px rgba(0,89,255,.35); }
    @media (max-width:420px){ .chat-log{ height:220px; } }
  </style>
</head>
<body>
  <div class="page-wrap">
    <header class="app-header">
      <a href="index.html" aria-label="Home">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home Icon" class="home-icon">
      </a>
    </header>

    <main class="content">
      <section class="hero">
        <h1 class="title">ğŸ“… ì¶”ì²œ ì¼ì •</h1>
        <div id="subtitle" class="subtitle"></div>
        <div id="notice" class="notice">ì¹´ë“œë¥¼ í´ë¦­í•´ í¸ì§‘í•˜ê³ , ì±„íŒ…ì°½ ìƒë‹¨ì˜ â€˜ì¼ì • í™•ì •â€™ì„ ëˆ„ë¥´ë©´ ìµœì¢… í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
        <div id="error" class="error"></div>
      </section>

      <section id="itinerary-list" class="list"></section>

      <section id="chat" class="chat">
        <div class="chat-header">
          <div class="chat-title" id="chat-title">ì¼ì • ëŒ€í™”</div>
          <div class="mode-tabs">
            <button id="tab-edit" class="active">ì¼ì • í¸ì§‘</button>
            <button id="btn-confirm">ì¼ì • í™•ì •</button>
          </div>
          <button class="chat-close" id="chat-close">ë‹«ê¸°</button>
        </div>
        <div id="chat-log" class="chat-log"></div>
        <div class="chat-input">
          <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ)" />
          <button id="chat-send">ì „ì†¡</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* ===== ì—”ë“œí¬ì¸íŠ¸ ===== */
    const API_PLAN      = "http://127.0.0.1:8000/api/plan";
    const CHAT_ENDPOINT = "http://127.0.0.1:8000/api/chat";
    const PLAN_COUNT = 1; // âœ… 3ê°œ ì¼ì • ìš”ì²­

    /* ===== ìœ í‹¸ ===== */
    const $ = (s)=>document.querySelector(s);
    function el(tag, cls, txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e; }
    function addMsg(role, text){ const log=$("#chat-log"); const row=el("div",`msg ${role}`); row.appendChild(el("div","bubble",text)); log.appendChild(row); log.scrollTop=log.scrollHeight; }
    function safeJSON(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch{ return fallback; } }

    function getContext(){
      return {
        destination: localStorage.getItem("justgo_selected_destination")
                    || localStorage.getItem("selectedLocation") || "",
        dates: safeJSON("selectedDates", []),
        companions: safeJSON("selectedCompanions", []),
        styles: safeJSON("selectedStyles", []),
        hasPet: localStorage.getItem("hasPet")==="true",
        budget: Number(localStorage.getItem("budget")||0),
        selected_places: safeJSON("justgo_selected_places",[])
      };
    }

    function showFallback(){
      console.warn("[plan] using local fallback");
      itineraries=[{ title:"ì¼ì •ì¶”ì²œ 1(ìƒ˜í”Œ)", body:"(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)", fullText:"ì¼ì •ì¶”ì²œ 1\n---\n(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)"}];
      renderCards();
      let warn=$("#backend-warning");
      if(!warn){
        warn=document.createElement("div");
        warn.id="backend-warning";
        warn.className="subtitle";
        warn.style.color="crimson";
        warn.textContent="(ë°±ì—”ë“œ ì‚¬ìš© ë¶ˆê°€ ë˜ëŠ” ë¹ˆ ì‘ë‹µ) ë¡œì»¬ ë°ì´í„°ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.";
        $("#subtitle").insertAdjacentElement("afterend", warn);
      }
    }

    /* ===== ìƒíƒœ ===== */
    let itineraries=[]; let selectedIndex=null; let currentBudget=300000;
    let chatMode="edit";

    /* ===== ë Œë” ===== */
    function renderCards(){
      const list=$("#itinerary-list"); list.innerHTML="";
      itineraries.forEach((it,i)=>{
        const card=el("div","itinerary-option"); card.dataset.index=String(i);
        const title=el("div","card-title", it.title||`ì¼ì •ì¶”ì²œ ${i+1}`);
        const bodyText=(typeof it.body==="string")?it.body:"";
        const sub=el("div","card-sub", bodyText.length>160?bodyText.slice(0,160)+"â€¦":(bodyText||"(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)"));
        const details=el("pre","details"); details.style.whiteSpace="pre-wrap"; details.style.display="none";
        details.textContent=(typeof it.fullText==="string")?it.fullText:(title.textContent+"\n---\n"+bodyText);
        const toggle=el("div","trip-line","ì „ì²´ ì¼ì • í¼ì¹˜ê¸° â–¾"); toggle.style.cursor="pointer";
        toggle.onclick=(e)=>{ e.stopPropagation(); const vis=details.style.display==="block"; details.style.display=vis?"none":"block"; toggle.textContent=vis?"ì „ì²´ ì¼ì • í¼ì¹˜ê¸° â–¾":"ì „ì²´ ì¼ì • ì ‘ê¸° â–´"; };
        card.appendChild(title); card.appendChild(sub); card.appendChild(toggle); card.appendChild(details); list.appendChild(card);
      });
    }

    /* ===== ì´ˆê¸° ë¡œë”© ===== */
    async function boot(){
      try{
        const ctx=getContext();
        const location=ctx.destination || "ê²½ì£¼";
        const days=3;
        const style=(ctx.styles && ctx.styles.length)?ctx.styles.join(", "):"ììœ  ì—¬í–‰";
        currentBudget=ctx.budget||300000;
        const start=ctx.dates?.[0] || "2025-08-13";
        const endDate=new Date(new Date(start).getTime()+(days-1)*86400000).toISOString().slice(0,10);
        $("#subtitle").innerText=`${location} Â· ${start} ~ ${endDate} Â· ì˜ˆì‚° ${currentBudget.toLocaleString()}ì› Â· ìŠ¤íƒ€ì¼ ${style}`;

        try{
          const res=await fetch(API_PLAN,{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
              location, days, style,
              companions: ctx.companions,
              budget: currentBudget,
              selected_places: ctx.selected_places,
              travel_date: start,
              count: PLAN_COUNT
            })
          });
          if(!res.ok) throw new Error("HTTP "+res.status);
          const data=await res.json();
          const list=Array.isArray(data.schedules)?data.schedules.slice(0,PLAN_COUNT):[];
          if(list.length===0) return showFallback();

          itineraries=list.map(s=>{
            const title=(s.title||"ì¼ì •ì¶”ì²œ").split("\n")[0].trim();
            const detail=(s.detail||s.body||s.itinerary||"").trim();
            const fullText=`${title}\n---\n${detail}`;
            return { title, body:detail, fullText };
          });
          $("#backend-warning")?.remove();
          renderCards();
        }catch(err){ console.error("[plan] fetch/parse error:",err); showFallback(); }
      }catch(fatal){ console.error("[boot] fatal:",fatal); showFallback(); }
    }

    /* ===== ì±„íŒ… íŒ¨ë„ ===== */
    document.addEventListener("click",(e)=>{
      const card=e.target.closest(".itinerary-option"); if(!card) return;
      selectedIndex=Number(card.dataset.index); const it=itineraries[selectedIndex];
      setChatMode("edit"); $("#chat-title").textContent=`ğŸ’¬ ${it.title} ëŒ€í™”`;
      $("#chat").style.display="block"; $("#chat-log").innerHTML="";
      addMsg("bot",`"${it.title}" ì¼ì •ì— ëŒ€í•´ ë¬´ì—‡ì„ ë°”ê¾¸ê³  ì‹¶ë‚˜ìš”?\nì˜ˆ) 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ, ì´ë™ ë™ì„ ì„ ë” ì§§ê²Œ ë“±`);
    });
    document.addEventListener("click",(e)=>{ if(e.target.id==="chat-close"){ $("#chat").style.display="none"; selectedIndex=null; } });
    $("#tab-edit").addEventListener("click",()=>{ setChatMode("edit"); if(selectedIndex!=null) addMsg("bot","í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜í–ˆì–´ìš”. ë°”ê¾¸ê³  ì‹¶ì€ ë‚´ìš©ì„ ë§í•´ ì£¼ì„¸ìš”."); else addMsg("bot","ë¨¼ì € ì¹´ë“œë¥¼ ëˆŒëŸ¬ ì¼ì •ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); });

    function setChatMode(mode){
      chatMode = "edit"; // ììœ ëŒ€í™” ì œê±° -> í•­ìƒ í¸ì§‘ ëª¨ë“œ
      $("#tab-edit").classList.add("active");
      $("#chat-input").placeholder = "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ)";
      if (selectedIndex != null) $("#chat-title").textContent = `ğŸ’¬ ${itineraries[selectedIndex].title} ëŒ€í™”`;
      else $("#chat-title").textContent = "ğŸ’¬ ì¼ì • ëŒ€í™”";
    }


    $("#chat-send").addEventListener("click", sendMessage);
    $("#chat-input").addEventListener("keydown",(e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    async function sendMessage(){
      const input=$("#chat-input"); const msg=input.value.trim(); if(!msg) return;
      addMsg("me",msg); input.value="";
      const ctx=getContext();

      // ì¼ì • í™•ì • â†’ localStorage ì €ì¥ í›„ justgofinal.htmlë¡œ ì´ë™
      document.getElementById("btn-confirm").addEventListener("click", () => {
        // ì„ íƒëœ ì¹´ë“œê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¼ì •ì„ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©
        const idx = (selectedIndex != null) ? selectedIndex : 0;
        if (!itineraries[idx]) {
          alert("í™•ì •í•  ì¼ì •ì´ ì—†ì–´ìš”. ë¨¼ì € ì¹´ë“œë¥¼ ëˆŒëŸ¬ ì¼ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
          return;
        }
        const full = itineraries[idx].fullText || "";
        localStorage.setItem("finalSchedule", full);
        window.location.href = "justgofinal.html";
      });


      // ì¼ì • í¸ì§‘ â†’ /api/chat
      if(selectedIndex==null){ addMsg("bot","ë¨¼ì € ì¹´ë“œë¥¼ ëˆŒëŸ¬ í¸ì§‘í•  ì¼ì •ì„ ì„ íƒí•´ ì£¼ì„¸ìš”!"); return; }
      const it=itineraries[selectedIndex];
      try{
        const res=await fetch(CHAT_ENDPOINT,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            q: msg,                          // í˜¸í™˜ì„±: që„ ê°™ì´ ì „ì†¡
            message: msg,                    // ê¸°ë³¸ ë©”ì‹œì§€
            itineraryIndex: selectedIndex,
            itineraryText: it.fullText,
            context:{ budget: currentBudget, destination: ctx.destination }
          })
        });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data=await res.json();
        const reply = data.reply || data.answer || data.result || data.message || "ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.";
        addMsg("bot", reply);

        // ë°±ì—”ë“œê°€ ìˆ˜ì •ëœ ì¼ì •ì„ ë¬¸ìì—´ë¡œ ì¤„ ê²½ìš° ê°±ì‹ 
        const updated = data.updatedItinerary || data.itinerary || data.fullText;
        if(updated && typeof updated==="string"){
          const lines=updated.split(/\r?\n/);
          const newTitle=(lines[0]||it.title).trim();
          // '---' ë‹¤ìŒë¶€í„° ë³¸ë¬¸
          const sepIndex = updated.indexOf('---');
          const body = sepIndex>=0 ? updated.slice(sepIndex+3).trim() : lines.slice(1).join("\n").trim();
          const fullText=updated.trim();
          itineraries[selectedIndex]={ title:newTitle, body, fullText };
          renderCards(); $("#chat-title").textContent=`ğŸ’¬ ${newTitle} ëŒ€í™”`;
        }
      }catch(err){
        console.error(err);
        addMsg("bot", `(ì„ì‹œ) "${msg}" ìš”ì²­ì„ ë°˜ì˜í–ˆìŠµë‹ˆë‹¤. (ë°±ì—”ë“œ ì˜¤ë¥˜/ì—°ê²° ë¬¸ì œ)`);
      }
    }

    document.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>
