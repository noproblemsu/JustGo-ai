<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¶”ì²œ ì¼ì •</title>
  <style>
    :root { --primary:#0059ff; --text:#000; --muted:#666; --bg:#f7f7f8; --panel:#fff; --border:#e6e6e6; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:Inter,"Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); }
    .page { max-width:860px; margin:0 auto; padding:16px; }
    .title { display:flex; align-items:center; gap:8px; font-size:22px; font-weight:700; }
    .subtitle { color:var(--muted); margin:6px 0 8px; }
    .notice { color:var(--muted); margin-bottom:16px; }
    .error { color:#c00; margin:10px 0; display:none; }
    .list { display:flex; flex-direction:column; gap:12px; }

    .itinerary-card { background:var(--panel); border:1px solid #dcdcdc; border-radius:12px; padding:16px; cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.05); transition:transform .06s ease, box-shadow .12s ease, background .15s ease; }
    .itinerary-card:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(0,0,0,.08); }
    .card-title { font-weight:700; }
    .card-sub { margin-top:6px; color:var(--muted); font-size:14px; white-space:pre-line; }

    .chat { margin-top:18px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; display:none; }
    .chat-header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .chat-title { font-weight:700; }
    .chat-close { border:none; background:#f2f4f7; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .chat-log { height:260px; overflow-y:auto; padding:8px; border:1px solid var(--border); border-radius:10px; background:#fafafa; }
    .msg { margin:10px 0; display:flex; gap:8px; }
    .bubble { max-width:80%; padding:10px 12px; border-radius:14px; line-height:1.4; background:#eef2ff; }
    .msg.me { justify-content:flex-end; }
    .msg.me .bubble { background:#dbeafe; }
    .msg.bot .bubble { background:#efefef; }
    .chat-input { display:flex; gap:8px; margin-top:10px; }
    .chat-input input { flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; font-size:15px; }
    .chat-input button { background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
    @media (max-width:420px){ .chat-log{height:220px;} }
  </style>
</head>
<body>
  <div class="page">
    <div class="title">ğŸ“… ì¶”ì²œ ì¼ì •</div>
    <div id="trip-info" class="subtitle"></div>
    <div class="notice">ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì±„íŒ…ì°½ì´ í¼ì³ì ¸ìš”.</div>
    <div id="error" class="error"></div>

    <div id="itinerary-list" class="list"></div>

    <div id="chat" class="chat">
      <div class="chat-header">
        <div class="chat-title" id="chat-title">ì¼ì • ëŒ€í™”</div>
        <button class="chat-close" id="chat-close">ë‹«ê¸°</button>
      </div>
      <div id="chat-log" class="chat-log"></div>
      <div class="chat-input">
        <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ)" />
        <button id="chat-send">ì „ì†¡</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ì„¤ì • =====
    const API_PLAN = "http://127.0.0.1:8000/api/plan";     // ë°±ì—”ë“œê°€ ìˆìœ¼ë©´ ì´ê±¸ë¡œ ì¼ì • ìƒì„±
    const CHAT_ENDPOINT = "http://127.0.0.1:8000/api/chat"; // ì±„íŒ… ë°±ì—”ë“œ
    const USE_BACKEND_CHAT = true;                           // /api/chat ì‚¬ìš© (ì—†ìœ¼ë©´ ìë™ í´ë°±)

    // ===== ìƒíƒœ =====
    let selectedIndex = null;
    let itineraries = [];

    // ===== ìœ í‹¸ =====
    const el = (t,c,x)=>{const e=document.createElement(t); if(c)e.className=c; if(x!==undefined)e.textContent=x; return e;};
    const $ = (s)=>document.querySelector(s);
    function addMsg(role, text){
      const log=$("#chat-log"); const row=el("div",`msg ${role}`); const bub=el("div","bubble"); bub.innerText=text;
      row.appendChild(bub); log.appendChild(row); log.scrollTop=log.scrollHeight;
    }
    function getTripInfo(){
      const loc=localStorage.getItem("selectedLocation")||"ê²½ì£¼";
      const dates=JSON.parse(localStorage.getItem("selectedDates")||"[]");
      const start=dates[0]||"2025-08-13"; const end=dates[1]||dates[0]||"2025-08-15";
      const budgetNum=Number(localStorage.getItem("budget")||300000);
      const budget=budgetNum.toLocaleString();
      const styles=JSON.parse(localStorage.getItem("selectedStyles")||"[]");
      const companions=JSON.parse(localStorage.getItem("selectedCompanions")||"[]");
      const styleStr=[...companions, ...(localStorage.getItem("hasPet")==="true"?["ë°˜ë ¤ë™ë¬¼ ë™ë°˜"]:[]), ...styles].join("/") || "ì„ íƒ ì—†ìŒ";
      return {loc:start?localStorage.getItem("selectedLocation")||"ê²½ì£¼":"ê²½ì£¼", start, end, budget, budgetNum, styles, companions, hasPet:localStorage.getItem("hasPet")==="true", styleStr};
    }
    function calcDays(s,e){const S=new Date(s), E=new Date(e||s); const d=Math.round((E-S)/(1000*60*60*24))+1; return isFinite(d)&&d>0?Math.min(Math.max(d,1),10):3;}
    function loadLocalItins(){
      const raw=localStorage.getItem("gpt_itineraries");
      if(raw){ try{const arr=JSON.parse(raw); if(Array.isArray(arr)&&arr.length) return arr.slice(0,3);}catch{} }
      return ["ì¼ì •ì¶”ì²œ 1 ìƒ˜í”Œ\n---\n(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)","ì¼ì •ì¶”ì²œ 2 ìƒ˜í”Œ\n---\n(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)","ì¼ì •ì¶”ì²œ 3 ìƒ˜í”Œ\n---\n(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)"];
    }
    function showError(msg){ const box=$("#error"); box.textContent=msg; box.style.display="block"; }

    // ===== ì´ˆê¸° =====
    document.addEventListener("DOMContentLoaded", boot);

    async function boot(){
      const info=getTripInfo();
      $("#trip-info").innerText=`${localStorage.getItem("selectedLocation")||"ê²½ì£¼"} Â· ${info.start} ~ ${info.end} Â· ì˜ˆì‚° ${info.budget}ì› Â· ìŠ¤íƒ€ì¼ ${info.styleStr}`;

      // 1) ë°±ì—”ë“œì—ì„œ ì¼ì • ë°›ì•„ì˜¤ê¸° ì‹œë„
      let usedBackend=false;
      try{
        const days=calcDays(info.start, info.end);
        const controller=new AbortController();
        const t=setTimeout(()=>controller.abort(), 6000); // 6ì´ˆ íƒ€ì„ì•„ì›ƒ
        const res=await fetch(API_PLAN,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          signal:controller.signal,
          body:JSON.stringify({
            location: localStorage.getItem("selectedLocation")||"ê²½ì£¼",
            days: days,
            style: (info.styles&&info.styles.length)?info.styles.join(", "):"ììœ  ì—¬í–‰",
            companions: info.companions||[],
            budget: info.budgetNum,
            selected_places: [],
            travel_date: info.start,
            count: 3
          })
        });
        clearTimeout(t);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data=await res.json(); // {schedules:[{title,detail}...]}
        const arr=data?.schedules;
        if(!Array.isArray(arr)||!arr.length) throw new Error("schedules ëˆ„ë½");
        itineraries=arr.slice(0,3).map((s,i)=>`${(s.title||`ì¼ì •ì¶”ì²œ ${i+1}`).trim()}\n---\n${(s.detail||"").trim()}`);
        usedBackend=true;
      }catch(e){
        // 2) ì‹¤íŒ¨í•˜ë©´ ë¡œì»¬ í´ë°±
        itineraries=loadLocalItins();
        showError(`(ë°±ì—”ë“œ ì‚¬ìš© ë¶ˆê°€: ${e.message || e}) ë¡œì»¬ ë°ì´í„°ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.`);
      }

      renderCards();

      // ë°±ì—”ë“œ ì´ìš© ì„±ê³µ ì‹œ ìºì‹œë„ ì—…ë°ì´íŠ¸(ì„ íƒ)
      if(usedBackend){ try{ localStorage.setItem("gpt_itineraries", JSON.stringify(itineraries)); }catch{} }
    }

    function renderCards(){
      const list=$("#itinerary-list"); list.innerHTML="";
      itineraries.forEach((text,i)=>{
        const firstLine=(text.split("\n")[0]||`ì¼ì •ì¶”ì²œ ${i+1}`).trim();
        const rest=text.split("\n").slice(2).join("\n").trim()||"(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)";
        const card=el("div","itinerary-card"); card.dataset.index=String(i);
        card.appendChild(el("div","card-title",firstLine));
        card.appendChild(el("div","card-sub",rest.length>160?rest.slice(0,160)+"â€¦":rest));
        card.addEventListener("click", onCardClick);
        list.appendChild(card);
      });
    }

    function onCardClick(e){
      const card=e.currentTarget;
      selectedIndex=Number(card.dataset.index);
      const heading=(itineraries[selectedIndex].split("\n")[0]||`ì¼ì •ì¶”ì²œ ${selectedIndex+1}`).trim();
      $("#chat-title").innerText=`ğŸ’¬ ${heading} ëŒ€í™”`;
      $("#chat").style.display="block";
      $("#chat-log").innerHTML="";
      addMsg("bot", `"${heading}" ì¼ì •ì— ëŒ€í•´ ë¬´ì—‡ì„ ë°”ê¿€ê¹Œìš”?\nì˜ˆ) 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ, ì´ë™ ë™ì„ ì„ ë” ì§§ê²Œ ë“±`);
    }

    // ë‹«ê¸°/ì „ì†¡ ë¦¬ìŠ¤ë„ˆ
    document.addEventListener("DOMContentLoaded", ()=>{
      $("#chat-close").addEventListener("click", ()=>{ $("#chat").style.display="none"; selectedIndex=null; });
      $("#chat-send").addEventListener("click", sendMessage);
      $("#chat-input").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendMessage(); });
    });

    // ===== ì±„íŒ… ì „ì†¡ =====
    async function sendMessage(){
      const input=$("#chat-input"); const msg=input.value.trim();
      if(!msg || selectedIndex==null) return;
      addMsg("me", msg); input.value="";

      const currentItin=itineraries[selectedIndex];
      const budgetNum=Number(localStorage.getItem("budget")||0) || null;

      if(USE_BACKEND_CHAT){
        try{
          const res=await fetch(CHAT_ENDPOINT,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
              message: msg,
              itineraryIndex: selectedIndex,
              itineraryText: currentItin,
              context: { budget: budgetNum }
            })
          });
          if(!res.ok) throw new Error("HTTP "+res.status);
          const data=await res.json();
          addMsg("bot", (data && (data.reply || data.message)) || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
          if(data && data.updatedItinerary){
            itineraries[selectedIndex]=data.updatedItinerary;
            renderCards();
            try{ localStorage.setItem("gpt_itineraries", JSON.stringify(itineraries)); }catch{}
          }
          return;
        }catch(e){
          showError(`(ì±„íŒ… ë°±ì—”ë“œ ì‚¬ìš© ë¶ˆê°€: ${e.message || e}) ì„ì‹œ ì‘ë‹µìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.`);
        }
      }
      // í´ë°±
      addMsg("bot", `ì„ì‹œ ì‘ë‹µ: "${msg}"ì— ë§ì¶° ì¼ì •ì„ ì¡°ì •í• ê²Œìš”. (ë°±ì—”ë“œ ì—°ê²° ì‹œ ì‹¤ì œ GPT ì‘ë‹µìœ¼ë¡œ ëŒ€ì²´)`);
    }
  </script>
</body>
</html>
