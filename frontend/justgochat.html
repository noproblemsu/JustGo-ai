<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>추천 일정</title>
  <style>
    :root {
      --primary: #0059ff;
      --text: #000;
      --muted: #666;
      --bg: #fff;
      --panel: #ffffff;
      --border: #e6e6e6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, "Apple SD Gothic Neo", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #f7f7f8;
      color: var(--text);
    }
    .page { max-width: 860px; margin: 0 auto; padding: 16px; }
    .title { display:flex; align-items:center; gap:8px; font-size:22px; font-weight:700; }
    .subtitle { color: var(--muted); margin: 6px 0 18px; }
    .list { display:flex; flex-direction:column; gap:12px; }

    .itinerary-card {
      background: var(--panel);
      border: 1px solid #dcdcdc;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
      transition: transform .06s ease, box-shadow .12s ease, background .15s ease;
    }
    .itinerary-card:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,0,0,.08); }
    .itinerary-card .card-title { font-weight: 700; }
    .itinerary-card .card-sub { margin-top:6px; color: var(--muted); font-size: 14px; white-space: pre-line; }

    .chat {
      margin-top: 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: none; /* 처음엔 숨김 */
    }
    .chat-header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .chat-title { font-weight:700; }
    .chat-close { border:none; background:#f2f4f7; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .chat-log {
      height: 260px; overflow-y:auto; padding: 8px; border:1px solid var(--border);
      border-radius: 10px; background:#fafafa;
    }
    .msg { margin: 10px 0; display:flex; gap:8px; }
    .msg.me { justify-content: flex-end; }
    .bubble {
      max-width: 80%;
      padding: 10px 12px; border-radius:14px; line-height:1.4;
      background:#eef2ff; /* me */
    }
    .msg.me .bubble { background:#dbeafe; }
    .msg.bot .bubble { background:#efefef; }

    .chat-input {
      display:flex; gap:8px; margin-top:10px;
    }
    .chat-input input {
      flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none;
      font-size:15px;
    }
    .chat-input button {
      background: var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    @media (max-width: 420px) {
      .chat-log { height: 220px; }
    }
    .trip-line { color:#444; font-size:14px; margin-top: 2px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="title">📅 추천 일정</div>
    <div id="trip-info" class="subtitle"></div>
    <div class="subtitle">카드를 클릭하면 채팅창이 펼쳐져요.</div>

    <!-- 일정 카드 리스트 -->
    <div id="itinerary-list" class="list"></div>

    <!-- 채팅 영역 -->
    <div id="chat" class="chat">
      <div class="chat-header">
        <div class="chat-title" id="chat-title">일정 대화</div>
        <button class="chat-close" id="chat-close">닫기</button>
      </div>
      <div id="chat-log" class="chat-log"></div>
      <div class="chat-input">
        <input id="chat-input" type="text" placeholder="메시지를 입력하세요 (예: 2일차 저녁을 더 가볍게)" />
        <button id="chat-send">전송</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 설정 =====
    const USE_BACKEND = true;           // FastAPI 연결 시 true
    const CHAT_ENDPOINT = "/api/chat";  // POST { message, itineraryIndex, itineraryText? }

    // ===== 도우미 =====
    function el(tag, cls, txt) {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (txt) e.textContent = txt;
      return e;
    }
    function addMsg(role, text) {
      const log = document.getElementById("chat-log");
      const row = el("div", `msg ${role}`);
      const bub = el("div", "bubble");
      bub.innerText = text;
      row.appendChild(bub);
      log.appendChild(row);
      log.scrollTop = log.scrollHeight;
    }
    function getLocalTripInfo() {
      const loc = localStorage.getItem("selectedLocation") || "경주";
      const dates = JSON.parse(localStorage.getItem("selectedDates") || "[]");
      const start = dates[0] || "2025-08-13";
      const end = dates[1] || "2025-08-15";
      const budget = Number(localStorage.getItem("budget") || "300000").toLocaleString();
      const styles = JSON.parse(localStorage.getItem("selectedStyles") || "[]");
      const companions = JSON.parse(localStorage.getItem("selectedCompanions") || "[]");
      const styleStr = [...companions, ...(localStorage.getItem("hasPet")==="true" ? ["반려동물 동반"] : []), ...styles].join("/");
      return { loc, start, end, budget, styleStr };
    }
    function loadItineraries() {
      // localStorage.gpt_itineraries = JSON.stringify(["일정추천 1 ...", "일정추천 2 ...", "일정추천 3 ..."])
      const raw = localStorage.getItem("gpt_itineraries");
      if (raw) {
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length) return arr.slice(0,3);
        } catch {}
      }
      // 샘플 (상세가 비어 있으면 '세부 내용 없음')
      return [
        "일정추천 1 샘플\n---\n(세부 내용 없음)",
        "일정추천 2 샘플\n---\n(세부 내용 없음)",
        "일정추천 3 샘플\n---\n(세부 내용 없음)"
      ];
    }

    // ===== 상태 =====
    let selectedIndex = null;
    let itineraries = [];

    // ===== 초기 렌더 =====
    document.addEventListener("DOMContentLoaded", () => {
      const { loc, start, end, budget, styleStr } = getLocalTripInfo();
      document.getElementById("trip-info").innerText = `경주 · ${start} ~ ${end} · 예산 ${budget}원 · 스타일 ${styleStr || "선택 없음"}`;

      itineraries = loadItineraries();
      const list = document.getElementById("itinerary-list");
      list.innerHTML = "";

      itineraries.forEach((text, i) => {
        const firstLine = (text.split("\n")[0] || `일정추천 ${i+1}`).trim();
        const rest = text.split("\n").slice(2).join("\n").trim() || "(세부 내용 없음)";

        const card = el("div", "itinerary-card");
        card.dataset.index = String(i);

        const title = el("div", "card-title", firstLine);
        const sub = el("div", "card-sub", rest.length > 160 ? rest.slice(0,160) + "…" : rest);

        card.appendChild(title);
        card.appendChild(sub);
        list.appendChild(card);
      });

      // 카드 클릭 → 채팅창 오픈
      list.addEventListener("click", (e) => {
        const card = e.target.closest(".itinerary-card");
        if (!card) return;
        selectedIndex = Number(card.dataset.index);
        const heading = (itineraries[selectedIndex].split("\n")[0] || `일정추천 ${selectedIndex+1}`).trim();
        document.getElementById("chat-title").innerText = `💬 ${heading} 대화`;
        document.getElementById("chat").style.display = "block";
        const log = document.getElementById("chat-log");
        log.innerHTML = "";
        addMsg("bot", `"${heading}" 일정에 대해 무엇을 바꾸고 싶나요?\n예) 2일차 저녁을 더 가볍게, 이동 동선을 더 짧게 등`);
      });

      // 닫기
      document.getElementById("chat-close").addEventListener("click", () => {
        document.getElementById("chat").style.display = "none";
        selectedIndex = null;
      });

      // 전송
      document.getElementById("chat-send").addEventListener("click", sendMessage);
      document.getElementById("chat-input").addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });
    });

    // ===== 전송 로직 =====
    async function sendMessage() {
      const input = document.getElementById("chat-input");
      const msg = input.value.trim();
      if (!msg) return;
      if (selectedIndex == null) return;

      addMsg("me", msg);
      input.value = "";

      const currentItin = itineraries[selectedIndex];

      if (USE_BACKEND) {
        try {
          const res = await fetch(CHAT_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: msg,
              itineraryIndex: selectedIndex,
              itineraryText: currentItin, // 서버에서 이어서 편집하고 싶을 때
            })
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          // 기대 응답: { reply: "..." , updatedItinerary?: "..." }
          const reply = (data && (data.reply || data.message)) || "응답을 받지 못했습니다.";
          addMsg("bot", reply);

          // 서버가 수정된 일정을 보내주면 카드/보관 갱신
          if (data && data.updatedItinerary) {
            itineraries[selectedIndex] = data.updatedItinerary;
            // 카드 요약도 업데이트
            const list = document.getElementById("itinerary-list");
            const card = list.querySelector(`.itinerary-card[data-index="${selectedIndex}"]`);
            if (card) {
              const firstLine = (data.updatedItinerary.split("\n")[0] || `일정추천 ${selectedIndex+1}`).trim();
              const rest = data.updatedItinerary.split("\n").slice(2).join("\n").trim() || "(세부 내용 없음)";
              card.querySelector(".card-title").textContent = firstLine;
              card.querySelector(".card-sub").textContent = rest.length > 160 ? rest.slice(0,160) + "…" : rest;
            }
            // localStorage에도 반영
            try {
              localStorage.setItem("gpt_itineraries", JSON.stringify(itineraries));
            } catch {}
          }
          return;
        } catch (err) {
          // 폴백으로 내려감
        }
      }
      // 백엔드 없거나 실패 시 폴백 응답
      addMsg("bot", `임시 응답: "${msg}"에 맞춰 일정을 조정할게요. (백엔드 연결 시 실제 GPT 응답으로 대체됩니다)`);
    }
  </script>
</body>
</html>
