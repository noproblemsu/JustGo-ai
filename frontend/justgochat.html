<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì¶”ì²œ ì¼ì •</title>
  <style>
    :root {
      --primary: #0059ff;
      --text: #000;
      --muted: #666;
      --bg: #fff;
      --panel: #ffffff;
      --border: #e6e6e6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, "Apple SD Gothic Neo", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #f7f7f8;
      color: var(--text);
    }
    .page { max-width: 860px; margin: 0 auto; padding: 16px; }
    .title { display:flex; align-items:center; gap:8px; font-size:22px; font-weight:700; }
    .subtitle { color: var(--muted); margin: 6px 0 18px; }
    .list { display:flex; flex-direction:column; gap:12px; }

    .itinerary-card {
      background: var(--panel);
      border: 1px solid #dcdcdc;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
      transition: transform .06s ease, box-shadow .12s ease, background .15s ease;
    }
    .itinerary-card:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,0,0,.08); }
    .itinerary-card .card-title { font-weight: 700; }
    .itinerary-card .card-sub { margin-top:6px; color: var(--muted); font-size: 14px; white-space: pre-line; }

    .chat {
      margin-top: 18px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: none; /* ì²˜ìŒì—” ìˆ¨ê¹€ */
    }
    .chat-header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .chat-title { font-weight:700; }
    .chat-close { border:none; background:#f2f4f7; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .chat-log {
      height: 260px; overflow-y:auto; padding: 8px; border:1px solid var(--border);
      border-radius: 10px; background:#fafafa;
    }
    .msg { margin: 10px 0; display:flex; gap:8px; }
    .msg.me { justify-content: flex-end; }
    .bubble {
      max-width: 80%;
      padding: 10px 12px; border-radius:14px; line-height:1.4;
      background:#eef2ff; /* me */
    }
    .msg.me .bubble { background:#dbeafe; }
    .msg.bot .bubble { background:#efefef; }

    .chat-input {
      display:flex; gap:8px; margin-top:10px;
    }
    .chat-input input {
      flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none;
      font-size:15px;
    }
    .chat-input button {
      background: var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    @media (max-width: 420px) {
      .chat-log { height: 220px; }
    }
    .trip-line { color:#444; font-size:14px; margin-top: 2px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="title">ğŸ“… ì¶”ì²œ ì¼ì •</div>
    <div id="trip-info" class="subtitle"></div>
    <div class="subtitle">ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì±„íŒ…ì°½ì´ í¼ì³ì ¸ìš”.</div>

    <!-- ì¼ì • ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ -->
    <div id="itinerary-list" class="list"></div>

    <!-- ì±„íŒ… ì˜ì—­ -->
    <div id="chat" class="chat">
      <div class="chat-header">
        <div class="chat-title" id="chat-title">ì¼ì • ëŒ€í™”</div>
        <button class="chat-close" id="chat-close">ë‹«ê¸°</button>
      </div>
      <div id="chat-log" class="chat-log"></div>
      <div class="chat-input">
        <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ)" />
        <button id="chat-send">ì „ì†¡</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ì„¤ì • =====
    const USE_BACKEND = true;           // FastAPI ì—°ê²° ì‹œ true
    const CHAT_ENDPOINT = "/api/chat";  // POST { message, itineraryIndex, itineraryText? }

    // ===== ë„ìš°ë¯¸ =====
    function el(tag, cls, txt) {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (txt) e.textContent = txt;
      return e;
    }
    function addMsg(role, text) {
      const log = document.getElementById("chat-log");
      const row = el("div", `msg ${role}`);
      const bub = el("div", "bubble");
      bub.innerText = text;
      row.appendChild(bub);
      log.appendChild(row);
      log.scrollTop = log.scrollHeight;
    }
    function getLocalTripInfo() {
      const loc = localStorage.getItem("selectedLocation") || "ê²½ì£¼";
      const dates = JSON.parse(localStorage.getItem("selectedDates") || "[]");
      const start = dates[0] || "2025-08-13";
      const end = dates[1] || "2025-08-15";
      const budget = Number(localStorage.getItem("budget") || "300000").toLocaleString();
      const styles = JSON.parse(localStorage.getItem("selectedStyles") || "[]");
      const companions = JSON.parse(localStorage.getItem("selectedCompanions") || "[]");
      const styleStr = [...companions, ...(localStorage.getItem("hasPet")==="true" ? ["ë°˜ë ¤ë™ë¬¼ ë™ë°˜"] : []), ...styles].join("/");
      return { loc, start, end, budget, styleStr };
    }
    function loadItineraries() {
      // localStorage.gpt_itineraries = JSON.stringify(["ì¼ì •ì¶”ì²œ 1 ...", "ì¼ì •ì¶”ì²œ 2 ...", "ì¼ì •ì¶”ì²œ 3 ..."])
      const raw = localStorage.getItem("gpt_itineraries");
      if (raw) {
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length) return arr.slice(0,3);
        } catch {}
      }
      // ìƒ˜í”Œ (ìƒì„¸ê°€ ë¹„ì–´ ìˆìœ¼ë©´ 'ì„¸ë¶€ ë‚´ìš© ì—†ìŒ')
      return [
        "ì¼ì •ì¶”ì²œ 1 ìƒ˜í”Œ\n---\n(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)",
        "ì¼ì •ì¶”ì²œ 2 ìƒ˜í”Œ\n---\n(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)",
        "ì¼ì •ì¶”ì²œ 3 ìƒ˜í”Œ\n---\n(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)"
      ];
    }

    // ===== ìƒíƒœ =====
    let selectedIndex = null;
    let itineraries = [];

    // ===== ì´ˆê¸° ë Œë” =====
    document.addEventListener("DOMContentLoaded", () => {
      const { loc, start, end, budget, styleStr } = getLocalTripInfo();
      document.getElementById("trip-info").innerText = `ê²½ì£¼ Â· ${start} ~ ${end} Â· ì˜ˆì‚° ${budget}ì› Â· ìŠ¤íƒ€ì¼ ${styleStr || "ì„ íƒ ì—†ìŒ"}`;

      itineraries = loadItineraries();
      const list = document.getElementById("itinerary-list");
      list.innerHTML = "";

      itineraries.forEach((text, i) => {
        const firstLine = (text.split("\n")[0] || `ì¼ì •ì¶”ì²œ ${i+1}`).trim();
        const rest = text.split("\n").slice(2).join("\n").trim() || "(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)";

        const card = el("div", "itinerary-card");
        card.dataset.index = String(i);

        const title = el("div", "card-title", firstLine);
        const sub = el("div", "card-sub", rest.length > 160 ? rest.slice(0,160) + "â€¦" : rest);

        card.appendChild(title);
        card.appendChild(sub);
        list.appendChild(card);
      });

      // ì¹´ë“œ í´ë¦­ â†’ ì±„íŒ…ì°½ ì˜¤í”ˆ
      list.addEventListener("click", (e) => {
        const card = e.target.closest(".itinerary-card");
        if (!card) return;
        selectedIndex = Number(card.dataset.index);
        const heading = (itineraries[selectedIndex].split("\n")[0] || `ì¼ì •ì¶”ì²œ ${selectedIndex+1}`).trim();
        document.getElementById("chat-title").innerText = `ğŸ’¬ ${heading} ëŒ€í™”`;
        document.getElementById("chat").style.display = "block";
        const log = document.getElementById("chat-log");
        log.innerHTML = "";
        addMsg("bot", `"${heading}" ì¼ì •ì— ëŒ€í•´ ë¬´ì—‡ì„ ë°”ê¾¸ê³  ì‹¶ë‚˜ìš”?\nì˜ˆ) 2ì¼ì°¨ ì €ë…ì„ ë” ê°€ë³ê²Œ, ì´ë™ ë™ì„ ì„ ë” ì§§ê²Œ ë“±`);
      });

      // ë‹«ê¸°
      document.getElementById("chat-close").addEventListener("click", () => {
        document.getElementById("chat").style.display = "none";
        selectedIndex = null;
      });

      // ì „ì†¡
      document.getElementById("chat-send").addEventListener("click", sendMessage);
      document.getElementById("chat-input").addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });
    });

    // ===== ì „ì†¡ ë¡œì§ =====
    async function sendMessage() {
      const input = document.getElementById("chat-input");
      const msg = input.value.trim();
      if (!msg) return;
      if (selectedIndex == null) return;

      addMsg("me", msg);
      input.value = "";

      const currentItin = itineraries[selectedIndex];

      if (USE_BACKEND) {
        try {
          const res = await fetch(CHAT_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: msg,
              itineraryIndex: selectedIndex,
              itineraryText: currentItin, // ì„œë²„ì—ì„œ ì´ì–´ì„œ í¸ì§‘í•˜ê³  ì‹¶ì„ ë•Œ
            })
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          // ê¸°ëŒ€ ì‘ë‹µ: { reply: "..." , updatedItinerary?: "..." }
          const reply = (data && (data.reply || data.message)) || "ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
          addMsg("bot", reply);

          // ì„œë²„ê°€ ìˆ˜ì •ëœ ì¼ì •ì„ ë³´ë‚´ì£¼ë©´ ì¹´ë“œ/ë³´ê´€ ê°±ì‹ 
          if (data && data.updatedItinerary) {
            itineraries[selectedIndex] = data.updatedItinerary;
            // ì¹´ë“œ ìš”ì•½ë„ ì—…ë°ì´íŠ¸
            const list = document.getElementById("itinerary-list");
            const card = list.querySelector(`.itinerary-card[data-index="${selectedIndex}"]`);
            if (card) {
              const firstLine = (data.updatedItinerary.split("\n")[0] || `ì¼ì •ì¶”ì²œ ${selectedIndex+1}`).trim();
              const rest = data.updatedItinerary.split("\n").slice(2).join("\n").trim() || "(ì„¸ë¶€ ë‚´ìš© ì—†ìŒ)";
              card.querySelector(".card-title").textContent = firstLine;
              card.querySelector(".card-sub").textContent = rest.length > 160 ? rest.slice(0,160) + "â€¦" : rest;
            }
            // localStorageì—ë„ ë°˜ì˜
            try {
              localStorage.setItem("gpt_itineraries", JSON.stringify(itineraries));
            } catch {}
          }
          return;
        } catch (err) {
          // í´ë°±ìœ¼ë¡œ ë‚´ë ¤ê°
        }
      }
      // ë°±ì—”ë“œ ì—†ê±°ë‚˜ ì‹¤íŒ¨ ì‹œ í´ë°± ì‘ë‹µ
      addMsg("bot", `ì„ì‹œ ì‘ë‹µ: "${msg}"ì— ë§ì¶° ì¼ì •ì„ ì¡°ì •í• ê²Œìš”. (ë°±ì—”ë“œ ì—°ê²° ì‹œ ì‹¤ì œ GPT ì‘ë‹µìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤)`);
    }
  </script>
</body>
</html>
