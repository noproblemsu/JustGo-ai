<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>추천 일정</title>
  <style>
    /* 화면: 가로 가운데, 세로 상단 + 회색 바깥배경 */
html, body{
  min-height: 100vh; width: 100vw;
  margin: 0; padding: 0;
  display: flex; justify-content: center; align-items: flex-start;
  background: #f0f0f0;   /* 카드 밖 회색 */
}
/* 회색만 보이도록 body는 투명 */
body{ background: transparent; }

    :root{
      --primary-blue:#0059ff;
      --border-blue:#0055ff;
      --text-dark:#000;
      --text-light:#fff;
      --bg-white:#fff;
      --bg:#f0f0f0;
      --border:#e7eaf0;
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family:Inter,"Istok Web","Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg); color:var(--text-dark);
    }
    .page-wrap{
  position: relative;
  width: 393px;
  height: 787px;                 /* ✅ 고정 높이 */
  margin: 0 auto;
  background: #fff;              /* 카드 배경 */
  display: flex;
  flex-direction: column;
  overflow: hidden; 
    }

    .app-header{ background-color:#0059ff; height:66px; display:flex; justify-content:flex-end; align-items:center; padding:11px 16px; }
    .home-icon{ width:30px; height:30px; display:block; }

    .content{
  flex: 1;
  overflow: auto;
  background: #fafafa;
  padding-bottom: 160px;   /* ✅ 채팅 박스 자리 확보 */
}
    .hero{ padding:14px 16px 6px; background:#fafafa; border-bottom:1px solid var(--border); }
    .title{ margin:0 0 6px; font-size:18px; font-weight:800; }
    .subtitle{ color:#555; margin:2px 0; font-size:13px; }
    .notice{ color:#6b7280; margin:4px 0 10px; font-size:12px; }
    .error{ color:#c62828; margin:8px 0; font-size:13px; display:none; }

    .list{ display:flex; flex-direction:column; gap:12px; padding:10px 16px 20px; }
    .itinerary-option{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px 14px; cursor:pointer; transition:transform .08s, box-shadow .15s, border-color .15s; box-shadow:0 2px 6px rgba(0,0,0,.04); }
    .itinerary-option:hover{ transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.08); border-color:#dbe2ff; }
    .card-title{ font-weight:800; font-size:15px; color:#111; }
    .card-sub{ margin-top:6px; color:#333; font-size:13px; white-space:pre-line; }
    .trip-line{ margin-top:8px; font-size:12px; color:#4b5563; user-select:none; }
    .details{ margin-top:8px; border-top:1px dashed #e6eaf2; padding-top:8px; font-size:12.5px; color:#374151; background:#fff; }

    .chat{
  position: absolute;   /* ✅ sticky → absolute */
  left: 0; right: 0; bottom: 0;
  background: #fff;
  border-top: 1px solid var(--border);
  box-shadow: 0 -6px 20px rgba(0,0,0,.08);
  border-top-left-radius: 16px;
  border-top-right-radius: 16px;
  padding: 10px 12px 12px;
  margin-top: 0;
  display: none;        /* 필요 시 JS로 보이게 */
  z-index: 5;
}

    .chat-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; gap:8px; }
    .chat-title{ font-weight:800; font-size:14px; }
    .mode-tabs{ display:flex; gap:6px; }
    .mode-tabs button{ border:1px solid var(--border-blue); background:#f7f8ff; color:#234; padding:6px 10px; border-radius:10px; cursor:pointer; font-size:12px; font-weight:700; }
    .mode-tabs button.active{ background:var(--primary-blue); color:#fff; }
    .chat-close{ border:none; background:#eef2ff; color:#234; padding:6px 10px; border-radius:10px; cursor:pointer; }
    .chat-log{ height:260px; overflow:auto; padding:10px; border:1px solid var(--border); border-radius:12px; background:#fafafa; }
    .msg{ margin:8px 0; display:flex; align-items:flex-end; }
    .msg .bubble{ max-width:78%; padding:9px 12px; border-radius:14px; line-height:1.45; font-size:14px; word-break:break-word; box-shadow:0 1px 2px rgba(0,0,0,.06); }
    .msg.me{ justify-content:flex-end; }
    .msg.me .bubble{ background:var(--primary-blue); color:#fff; border-top-right-radius:4px; }
    .msg.bot{ justify-content:flex-start; }
    .msg.bot .bubble{ background:#eee; color:#111; border-top-left-radius:4px; }
    .chat-input{ display:flex; gap:8px; margin-top:10px; }
    .chat-input input{ flex:1; padding:12px; border:1.5px solid var(--border-blue); background:#f7f8ff; border-radius:14px; outline:none; font-size:14px; }
    .chat-input button{ background:var(--primary-blue); color:#fff; border:none; padding:12px 14px; border-radius:14px; cursor:pointer; font-weight:700; box-shadow:0 2px 8px rgba(0,89,255,.35); }
    @media (max-width:420px){ .chat-log{ height:220px; } }
  </style>
</head>
<body>
  <div class="page-wrap">
    <header class="app-header">
      <a href="index.html" aria-label="Home">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Home Icon" class="home-icon">
      </a>
    </header>

    <main class="content">
      <section class="hero">
        <h1 class="title">📅 추천 일정</h1>
        <div id="subtitle" class="subtitle"></div>
        <div id="notice" class="notice">카드를 클릭해 편집하고, 채팅창 상단의 ‘일정 확정’을 누르면 최종 화면으로 이동합니다.</div>
        <div id="error" class="error"></div>
      </section>

      <section id="itinerary-list" class="list"></section>

      <section id="chat" class="chat">
        <div class="chat-header">
          <div class="chat-title" id="chat-title">일정 대화</div>
          <div class="mode-tabs">
            <button id="tab-edit" class="active">일정 편집</button>
            <button id="btn-confirm">일정 확정</button>
          </div>
          <button class="chat-close" id="chat-close">닫기</button>
        </div>
        <div id="chat-log" class="chat-log"></div>
        <div class="chat-input">
          <input id="chat-input" type="text" placeholder="메시지를 입력하세요 (예: 2일차 저녁을 더 가볍게)" />
          <button id="chat-send">전송</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* ===== 엔드포인트 ===== */
    const API_PLAN      = "http://127.0.0.1:8000/api/plan";
    const CHAT_ENDPOINT = "http://127.0.0.1:8000/api/chat";
    const PLAN_COUNT = 1; // ✅ 3개 일정 요청

    /* ===== 유틸 ===== */
    const $ = (s)=>document.querySelector(s);
    function el(tag, cls, txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e; }
    function addMsg(role, text){ const log=$("#chat-log"); const row=el("div",`msg ${role}`); row.appendChild(el("div","bubble",text)); log.appendChild(row); log.scrollTop=log.scrollHeight; }
    function safeJSON(key, fallback){ try{ const v=localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch{ return fallback; } }

    function getContext(){
      return {
        destination: localStorage.getItem("justgo_selected_destination")
                    || localStorage.getItem("selectedLocation") || "",
        dates: safeJSON("selectedDates", []),
        companions: safeJSON("selectedCompanions", []),
        styles: safeJSON("selectedStyles", []),
        hasPet: localStorage.getItem("hasPet")==="true",
        budget: Number(localStorage.getItem("budget")||0),
        selected_places: safeJSON("justgo_selected_places",[])
      };
    }

    function showFallback(){
      console.warn("[plan] using local fallback");
      itineraries=[{ title:"일정추천 1(샘플)", body:"(세부 내용 없음)", fullText:"일정추천 1\n---\n(세부 내용 없음)"}];
      renderCards();
      let warn=$("#backend-warning");
      if(!warn){
        warn=document.createElement("div");
        warn.id="backend-warning";
        warn.className="subtitle";
        warn.style.color="crimson";
        warn.textContent="(백엔드 사용 불가 또는 빈 응답) 로컬 데이터로 표시합니다.";
        $("#subtitle").insertAdjacentElement("afterend", warn);
      }
    }

    /* ===== 상태 ===== */
    let itineraries=[]; let selectedIndex=null; let currentBudget=300000;
    let chatMode="edit";
    let ctxForSave = { location:"", start:"", end:"" };

    /* ===== 렌더 ===== */
    function renderCards(){
      const list=$("#itinerary-list"); list.innerHTML="";
      itineraries.forEach((it,i)=>{
        const card=el("div","itinerary-option"); card.dataset.index=String(i);
        const title=el("div","card-title", it.title||`일정추천 ${i+1}`);
        const bodyText=(typeof it.body==="string")?it.body:"";
        const sub=el("div","card-sub", bodyText.length>160?bodyText.slice(0,160)+"…":(bodyText||"(세부 내용 없음)"));
        const details=el("pre","details"); details.style.whiteSpace="pre-wrap"; details.style.display="none";
        details.textContent=(typeof it.fullText==="string")?it.fullText:(title.textContent+"\n---\n"+bodyText);
        const toggle=el("div","trip-line","전체 일정 펼치기 ▾"); toggle.style.cursor="pointer";
        toggle.onclick=(e)=>{ e.stopPropagation(); const vis=details.style.display==="block"; details.style.display=vis?"none":"block"; toggle.textContent=vis?"전체 일정 펼치기 ▾":"전체 일정 접기 ▴"; };
        card.appendChild(title); card.appendChild(sub); card.appendChild(toggle); card.appendChild(details); list.appendChild(card);
      });
    }

    /* ===== 초기 로딩 ===== */
    async function boot(){
      try{
        const ctx=getContext();
        const location=ctx.destination || "경주";
        const days=3;
        const style=(ctx.styles && ctx.styles.length)?ctx.styles.join(", "):"자유 여행";
        currentBudget=ctx.budget||300000;
        const start=ctx.dates?.[0] || "2025-08-13";
        const endDate=new Date(new Date(start).getTime()+(days-1)*86400000).toISOString().slice(0,10);
        $("#subtitle").innerText=`${location} · ${start} ~ ${endDate} · 예산 ${currentBudget.toLocaleString()}원 · 스타일 ${style}`;
        ctxForSave = { location, start, end: endDate };

        try{
          const res=await fetch(API_PLAN,{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
              location, days, style,
              companions: ctx.companions,
              budget: currentBudget,
              selected_places: ctx.selected_places,
              travel_date: start,
              count: PLAN_COUNT
            })
          });
          if(!res.ok) throw new Error("HTTP "+res.status);
          const data=await res.json();
          const list=Array.isArray(data.schedules)?data.schedules.slice(0,PLAN_COUNT):[];
          if(list.length===0) return showFallback();

          itineraries=list.map(s=>{
            const title=(s.title||"일정추천").split("\n")[0].trim();
            const detail=(s.detail||s.body||s.itinerary||"").trim();
            const fullText=`${title}\n---\n${detail}`;
            return { title, body:detail, fullText };
          });
          $("#backend-warning")?.remove();
          renderCards();
        }catch(err){ console.error("[plan] fetch/parse error:",err); showFallback(); }
      }catch(fatal){ console.error("[boot] fatal:",fatal); showFallback(); }
    }

    /* ===== 채팅 패널 ===== */
    document.addEventListener("click",(e)=>{
      const card=e.target.closest(".itinerary-option"); if(!card) return;
      selectedIndex=Number(card.dataset.index); const it=itineraries[selectedIndex];
      setChatMode("edit"); $("#chat-title").textContent=`💬 ${it.title} 대화`;
      $("#chat").style.display="block"; $("#chat-log").innerHTML="";
      addMsg("bot",`"${it.title}" 일정에 대해 무엇을 바꾸고 싶나요?\n예) 2일차 저녁을 더 가볍게, 이동 동선을 더 짧게 등`);
    });
    document.addEventListener("click",(e)=>{ if(e.target.id==="chat-close"){ $("#chat").style.display="none"; selectedIndex=null; } });
    $("#tab-edit").addEventListener("click",()=>{ setChatMode("edit"); if(selectedIndex!=null) addMsg("bot","편집 모드로 전환했어요. 바꾸고 싶은 내용을 말해 주세요."); else addMsg("bot","먼저 카드를 눌러 일정을 선택해 주세요."); });

    function setChatMode(mode){
      chatMode = "edit"; // 자유대화 제거 -> 항상 편집 모드
      $("#tab-edit").classList.add("active");
      $("#chat-input").placeholder = "메시지를 입력하세요 (예: 2일차 저녁을 더 가볍게)";
      if (selectedIndex != null) $("#chat-title").textContent = `💬 ${itineraries[selectedIndex].title} 대화`;
      else $("#chat-title").textContent = "💬 일정 대화";
    }

            function saveSchedule(fullText){
          const id = 'plan_' + Date.now();
          const title = ctxForSave.location || '여행';
          const start = ctxForSave.start || '';
          const end   = ctxForSave.end   || '';

          // 1) 호환 키 1: savedItineraries (+ 상세)
          const list = JSON.parse(localStorage.getItem('savedItineraries') || '[]');
          const displayTitle = end
            ? `${title} (${start.replace(/-/g,'.')} ~ ${end.replace(/-/g,'.')})`
            : `${title} (${start.replace(/-/g,'.')})`;
          list.unshift({ id, displayTitle, createdAt: new Date().toISOString() });
          localStorage.setItem('savedItineraries', JSON.stringify(list));
          localStorage.setItem('itinerary:' + id, JSON.stringify({ title, text: fullText }));

          // 2) 호환 키 2: justgo_schedules
          const alt = JSON.parse(localStorage.getItem('justgo_schedules') || '[]');
          alt.unshift({ id, title, start, end });
          localStorage.setItem('justgo_schedules', JSON.stringify(alt));

          return id;
        }

            document.getElementById("btn-confirm").addEventListener("click", () => {
          const idx = (selectedIndex != null) ? selectedIndex : 0;
          if (!itineraries[idx]) {
            alert("확정할 일정이 없어요. 먼저 카드를 눌러 일정을 확인해주세요.");
            return;
          }
          const full = itineraries[idx].fullText || "";
          localStorage.setItem("finalSchedule", full);
          window.location.href = "justgofinal.html";
        });

        document.addEventListener('DOMContentLoaded', ()=>{
      const btn = document.getElementById('btn-confirm');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        const idx = (selectedIndex != null) ? selectedIndex : 0;
        if (!itineraries[idx]) {
          alert("확정할 일정이 없어요. 먼저 카드를 눌러 일정을 선택해주세요.");
          return;
        }
        const full = itineraries[idx].fullText || "";

        // ✅ 로컬 저장(인덱스 목록용)
        const sid = saveSchedule(full);

        // ✅ 최종 화면(PDF 버튼 있는 페이지)으로 이동
        localStorage.setItem('finalSchedule', full);
        location.href = `justgofinal.html?sid=${encodeURIComponent(sid)}`;
      });
    });



    $("#chat-send").addEventListener("click", sendMessage);
    $("#chat-input").addEventListener("keydown",(e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    async function sendMessage(){
      const input=$("#chat-input"); const msg=input.value.trim(); if(!msg) return;
      addMsg("me",msg); input.value="";
      const ctx=getContext();

      // 일정 확정 → localStorage 저장 후 justgofinal.html로 이동
      document.getElementById("btn-confirm").addEventListener("click", () => {
        // 선택된 카드가 없으면 첫 번째 일정을 기본으로 사용
        const idx = (selectedIndex != null) ? selectedIndex : 0;
        if (!itineraries[idx]) {
          alert("확정할 일정이 없어요. 먼저 카드를 눌러 일정을 확인해주세요.");
          return;
        }
        const full = itineraries[idx].fullText || "";
        localStorage.setItem("finalSchedule", full);
        window.location.href = "justgofinal.html";
      });


      // 일정 편집 → /api/chat
      if(selectedIndex==null){ addMsg("bot","먼저 카드를 눌러 편집할 일정을 선택해 주세요!"); return; }
      const it=itineraries[selectedIndex];
      try{
        const res=await fetch(CHAT_ENDPOINT,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            q: msg,                          // 호환성: q도 같이 전송
            message: msg,                    // 기본 메시지
            itineraryIndex: selectedIndex,
            itineraryText: it.fullText,
            context:{ budget: currentBudget, destination: ctx.destination }
          })
        });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data=await res.json();
        const reply = data.reply || data.answer || data.result || data.message || "수정했습니다.";
        addMsg("bot", reply);

        // 백엔드가 수정된 일정을 문자열로 줄 경우 갱신
        const updated = data.updatedItinerary || data.itinerary || data.fullText;
        if(updated && typeof updated==="string"){
          const lines=updated.split(/\r?\n/);
          const newTitle=(lines[0]||it.title).trim();
          // '---' 다음부터 본문
          const sepIndex = updated.indexOf('---');
          const body = sepIndex>=0 ? updated.slice(sepIndex+3).trim() : lines.slice(1).join("\n").trim();
          const fullText=updated.trim();
          itineraries[selectedIndex]={ title:newTitle, body, fullText };
          renderCards(); $("#chat-title").textContent=`💬 ${newTitle} 대화`;
        }
      }catch(err){
        console.error(err);
        addMsg("bot", `(임시) "${msg}" 요청을 반영했습니다. (백엔드 오류/연결 문제)`);
      }
    }

    document.addEventListener("DOMContentLoaded", boot);


/* savedItineraries / justgo_schedules 둘 다 읽기 + 없으면 마이그레이션 */
(function(){
  const LIST_KEY = "savedItineraries";      // [{id, displayTitle, createdAt}]
  const ALT_KEY  = "justgo_schedules";      // [{id, title, start, end}]
  const DETAIL_PREFIX = "itinerary:";

  document.addEventListener("DOMContentLoaded", () => {
    migrateIfNeeded();  // ← 한 번 병합
    render();
  });

  function migrateIfNeeded(){
    const a = JSON.parse(localStorage.getItem(LIST_KEY) || "[]");
    const b = JSON.parse(localStorage.getItem(ALT_KEY)  || "[]");
    if (a.length || !b.length) return; // savedItineraries가 있거나, alt가 비었으면 패스

    // alt → savedItineraries 로 변환 저장
    const merged = b.map(x => {
      const title = x.title || "여행";
      const displayTitle = x.end
        ? `${title} (${fmt(x.start)} ~ ${fmt(x.end)})`
        : `${title} (${fmt(x.start)})`;
      return { id: x.id, displayTitle, createdAt: new Date().toISOString() };
    });
    localStorage.setItem(LIST_KEY, JSON.stringify(merged));
  }

  function render(){
    const root = document.getElementById("schedule-root");
    const data = loadUnified();    // 둘 중 있는 걸 통합해서 반환
    root.innerHTML = "";

    if (!data.length) {
      root.innerHTML = `<div class="empty"><div class="empty-emoji">📭</div>
        <p class="empty-title">저장된 일정이 없습니다.</p>
        <p class="empty-sub">상단의 “내 일정 만들기”로 새 일정을 생성하세요.</p></div>`;
      return;
    }

    const ul = document.createElement("ul"); ul.className = "schedule-list";
    data.forEach(item=>{
      const li = document.createElement("li"); li.className = "schedule-item";
      const title = document.createElement("div"); title.className="item-title";
      title.textContent = item.end ? `${item.title} (${fmt(item.start)} ~ ${fmt(item.end)})`
                                   : `${item.title} (${fmt(item.start)})`;
      const btns = document.createElement("div"); btns.className="schedule-buttons";
      const view = document.createElement("button"); view.className="btn btn-view"; view.textContent="보기";
      const del  = document.createElement("button"); del.className="btn btn-delete"; del.textContent="삭제";

      view.addEventListener("click", ()=> {
        location.href = `justgochat.html?itinerary=${encodeURIComponent(item.id)}`;
      });
      del.addEventListener("click", ()=> {
        if (!confirm("이 일정을 삭제할까요?")) return;
        removeUnified(item.id); render();
      });

      btns.append(view, del);
      li.append(title, btns);
      ul.appendChild(li);
    });

    root.appendChild(ul);
  }

  function loadUnified(){
    const a = JSON.parse(localStorage.getItem(LIST_KEY) || "[]");
    if (Array.isArray(a) && a.length){
      return a.map(x=>{
        const rgx = /\((\d{4}\.\d{2}\.\d{2})(?:\s*~\s*(\d{4}\.\d{2}\.\d{2}))?\)/;
        const m = rgx.exec(x.displayTitle||"");
        const title = (x.displayTitle||"여행").replace(/\s*\(.+\)\s*$/,"");
        return {
          id: x.id,
          title,
          start: m?.[1]?.replace(/\./g,"-") || null,
          end:   m?.[2]?.replace(/\./g,"-") || null
        };
      });
    }
    const b = JSON.parse(localStorage.getItem(ALT_KEY) || "[]");
    if (Array.isArray(b) && b.length) return b;
    return [];
  }

  function removeUnified(id){
    const a = JSON.parse(localStorage.getItem(LIST_KEY) || "[]").filter(x=>x.id!==id);
    localStorage.setItem(LIST_KEY, JSON.stringify(a));
    const b = JSON.parse(localStorage.getItem(ALT_KEY) || "[]").filter(x=>x.id!==id);
    localStorage.setItem(ALT_KEY, JSON.stringify(b));
    localStorage.removeItem(DETAIL_PREFIX + id);
  }

  function fmt(d){
    if(!d) return "";
    if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return d.replace(/-/g,".");
    const t = new Date(d); if(isNaN(t)) return d;
    const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,"0"), dd=String(t.getDate()).padStart(2,"0");
    return `${y}.${m}.${dd}`;
  }
})();
  </script>
</body>
</html>
