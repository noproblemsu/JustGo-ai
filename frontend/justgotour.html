<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê´€ê´‘ì§€ ì¶”ì²œ</title>
  <style>
     /* í™”ë©´ ì¤‘ì•™ì— 393Ã—787 ì¹´ë“œ ë°°ì¹˜ */
html, body {
  min-height: 100vh;           /* height â†’ min-height ê¶Œì¥ */
  width: 100vw;
  margin: 0; padding: 0;
  display: flex;
  justify-content: center;      /* ê°€ë¡œë§Œ ê°€ìš´ë° ìœ ì§€ */
  align-items: flex-start;       /* âœ… ì„¸ë¡œëŠ” ë§¨ ìœ„ë¡œ */
  background: #f0f0f0;
}
 /* âœ… í—¤ë”(206px) ì•„ë˜ì—ì„œ ì‹œì‘í•´ì„œ, í‘¸í„°ë¥¼ í”¼í•´ ë©ˆì¶”ê²Œ */
.page{
  position: absolute;
  top: 206px;          /* í—¤ë” ë†’ì´ */
  bottom: 120px;       /* í‘¸í„°+ì—¬ìœ  ë†’ì´(í•„ìš”ì‹œ 110~140px ì‚¬ì´ë¡œ ë¯¸ì„¸ì¡°ì •) */
  left: 0; right: 0;
  padding: 0 16px;
}


    :root {
      --text-primary: #000;
      --text-subtle: #666;
      --text-white: #fff;
      --bg-main: #fff;
      --bg-light: #f5f5f5;
      --border: #e6e6e6;
      --blue: #0059ff;
      --black: #111;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter','Istok Web',system-ui,sans-serif;background:var(--bg-main);color:var(--text-primary)}
   
    h1{font-size:30px;line-height:1.35;margin:0 0 8px;font-weight:800}
.fixed{
      position:absolute; top:0; left:0; right:0;
      background:#fff; z-index:10;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
    }      .fixed-inner{padding:50px 16px 16px}
    .summary{background:var(--bg-light);border-radius:12px;padding:10px 12px}
    .summary .title{font-weight:600;margin:0 0 4px}
    .chips{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;color:var(--text-subtle)}
    .dot{width:3px;height:3px;background:#aaa;border-radius:50%;display:inline-block}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .select{position:relative}
    select{appearance:none;font-size:13px;padding:6px 30px 6px 12px;border-radius:8px;border:1px solid var(--border);background:#fff}
    .arrow{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:10px;height:6px;background-image:url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23000' stroke-width='1.5'/%3E%3C/svg%3E")}
    .count{font-size:14px}
    
    .list{ display:flex; flex-direction:column; gap:16px; padding-top: 60px; }
    .card{display:flex;gap:12px;border:1px solid var(--border);border-radius:12px;background:#fff;padding:12px}
    .thumb{width:104px;height:104px;border-radius:10px;background:#ddd;background-size:cover;background-position:center;flex-shrink:0}
    .body{flex:1;display:flex;flex-direction:column;gap:6px}
    .name{font-weight:700}
    .meta,.rate{font-size:12px;color:var(--text-subtle)}
    .scroll{
  height: 100%;
  overflow: auto;
  padding-right: 4px;
  padding-bottom: 60px;
  margin-top: 0;
}
    .actions{display:flex;gap:8px;align-items:center;margin-top:auto}
    .map{font-size:12px;color:var(--blue);text-decoration:underline}
    .pick{margin-left:auto;background:var(--black);color:#fff;border:0;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
    .picked{background:#00aa55}
     .footer{position:absolute; left:0; right:0; bottom:27px; background:#fff}
    .footer-inner{padding:12px 16px 28px}
    .cta{width:100%;background:var(--blue);color:#fff;border:0;border-radius:8px;padding:15px 14px;font-weight:600;font-size:18px} 
    .skip{display:block;margin-top:8px;text-align:center;font-size:12px;color:var(--text-primary);text-decoration:none; letter-spacing: -0.7px;font-weight: 540; }    .empty{color:var(--text-subtle);font-size:14px}
    .toast{position:absolute;left:50%;transform:translateX(-50%);bottom:90px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;font-size:13px;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1}

    #complete-btn { display: none !important; }
.container {
  position: relative;       /* ìì‹ absoluteì˜ ê¸°ì¤€ */
  width: 393px; height: 787px;
  background: #fff;         /* ì¹´ë“œ ë°°ê²½ */
  overflow: hidden;
  
  
}

/* body ë°°ê²½ì€ ì¹´ë“œ ë°–ë§Œ ë³´ì´ë„ë¡ íˆ¬ëª… ì¶”ì²œ */
body { background: transparent; }

  </style>


</head>
<body>
  <div class="container">
  <div class="fixed">
    <div class="fixed-inner">
      <h1>ì›í•˜ëŠ” ê´€ê´‘ì§€ë¥¼<br/>ì„ íƒí•´ì£¼ì„¸ìš”.</h1>
      <div class="summary">
        <p class="title">ê´€ê´‘ì§€ ì¶”ì²œ</p>
        <div class="chips" id="chips"></div>
      </div>
      <div class="bar">
        <div class="select">
          <select id="sort">
            <option value="review_desc" selected>ë¦¬ë·° ë§ì€ ìˆœ</option>
          </select>
          <span class="arrow"></span>
        </div>
        <div class="count" id="count">ê²°ê³¼ 0ê°œ</div>
      </div>
    </div>
  </div>

  <main class="page">
    <div class="scroll">
      <section class="list" id="list"></section>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <button id="done" class="cta">ì™„ë£Œ</button>
      <!-- ì™„ë£Œ ë²„íŠ¼ -->
      <button id="complete-btn" class="complete-btn">ì™„ë£Œ (ì„ íƒ 3)</button>
      <a class="skip" href="#">ë‹¤ìŒì— í•˜ê¸°</a>
    </div>
  </footer>

  <div id="toast" class="toast"></div>

<script>
const API_BASE = "http://127.0.0.1:8000";
const $ = s => document.querySelector(s);

// âœ… ëª©ì ì§€(ì—¬í–‰ì§€) ì „ì—­ìœ¼ë¡œ í™•ë³´
const selectedDestination = localStorage.getItem('selectedLocation') || "";

const sortSel = $("#sort");
const listEl   = $("#list");
const countEl  = $("#count");
const doneBtn  = $("#done");
const chipsEl  = $("#chips");
const toastEl  = $("#toast");

// ---- ì•ˆì „ í—¬í¼ (selected / destination ë³´ì™„) ----
function getDestinationSafe() {
  // ìš°ì„ ìˆœìœ„: ì „ì—­ ë³€ìˆ˜ â†’ localStorage â†’ ì…ë ¥ìš”ì†Œ
  const fromVar = (typeof selectedDestination === 'string' ? selectedDestination : '') || '';
  const fromLS  = localStorage.getItem('selectedLocation') || '';
  const fromUI  = document.querySelector('#destination')?.value || '';
  return (fromVar || fromLS || fromUI).trim();
}

function getSelectedPlacesSafe() {
  // ì „ì—­ Set(selected)ì´ ì •ìƒì¼ ë•Œ
  try {
    if (window.selected instanceof Set) {
      const arr = Array.from(window.selected);
      if (arr.length) return arr;
    }
  } catch (_) {}
  // í´ë°±: DOMì—ì„œ 'ì„ íƒë¨' í‘œì‹œëœ ë²„íŠ¼ ìˆ˜ì§‘
  return Array.from(document.querySelectorAll('.pick.picked'))
    .map(btn => btn.dataset.pick || btn.textContent.trim())
    .filter(Boolean);
}


// ì„ íƒ ìƒíƒœ
const selected = new Set();  // place nameë§Œ ì €ì¥

// ---- ìœ í‹¸ ----
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1500);
}
function esc(s){return String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}

function lsJSON(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key)||"null") ?? fallback; }catch{ return fallback; }
}
function toLocalYMD(input){
  if(!input) return null;
  if(/^\d{4}-\d{2}-\d{2}$/.test(input)) return input;
  const d = new Date(input); if(isNaN(d)) return String(input).slice(0,10);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function fmtMD(s){ const ymd = toLocalYMD(s); if(!ymd) return ""; const [y,m,d] = ymd.split("-").map(Number); return `${m}ì›” ${d}ì¼`; }

// ---- í—¤ë” ì¹© ----
function hydrateChips(){
  const loc = (localStorage.getItem("selectedLocation") || "ì—¬ìˆ˜").trim();
  const dates = lsJSON("selectedDates", []);
  const comps = lsJSON("selectedCompanions", []);
  const styles= lsJSON("selectedStyles", []);
  const hasPet = localStorage.getItem("hasPet")==="true";

  const dateChip = dates.length>=2 ? `${fmtMD(dates[0])} ~ ${fmtMD(dates[1])}` :
                    dates.length===1 ? fmtMD(dates[0]) : "";
  const compChip = comps.length ? comps.join(" Â· ") : "í˜¼ì";
  const petChip  = `ë°˜ë ¤ê²¬ ${hasPet?"O":"X"}`;
  const styleChip= styles.join(" Â· ");

  const chips = [dateChip, compChip, petChip, styleChip].filter(Boolean);
  chipsEl.innerHTML = chips.map(c=>`<span>${esc(c)}</span>`).join(' <span class="dot"></span> ');
  document.title = `${loc} ê´€ê´‘ì§€ ì„ íƒ`;
}

// ---- í˜ì´ë¡œë“œ ----
function getPayload(){
  const destination = (localStorage.getItem("selectedLocation") || "ì—¬ìˆ˜").trim();
  const styles      = lsJSON("selectedStyles", []);
  const companions  = lsJSON("selectedCompanions", []);
  const dates       = lsJSON("selectedDates", []);
  const start_date  = dates[0] || null;
  const end_date    = dates[1] || null;
  const budgetStr   = (localStorage.getItem("budget")||"").replace(/,/g,"").trim();
  const budget      = budgetStr ? Number(budgetStr) : null;
  const has_pet     = localStorage.getItem("hasPet")==="true";

  return {
    location: destination,
    styles, companions, has_pet, budget, start_date, end_date,
    sort: "review_desc",
    limit: 20
  };
}

// ---- ë°ì´í„° ë¡œë“œ ----
async function loadPlaces(){
  const body = getPayload();
  listEl.innerHTML = "";
  countEl.textContent = "ë¡œë”© ì¤‘â€¦";

  const res = await fetch(`${API_BASE}/api/recommend/places_flex`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });
  const data = await res.json();
  const items = Array.isArray(data?.places)? data.places : [];

  countEl.textContent = `ê²°ê³¼ ${items.length}ê°œ`;
  if(!items.length){
    listEl.innerHTML = `<div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”. í‚¤ì›Œë“œ/ì •ë ¬ì„ ë³€ê²½í•´ë³´ì„¸ìš”.</div>`;
    return;
  }
  listEl.innerHTML = items.map(placeCardHTML).join("");
  // ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  listEl.querySelectorAll("[data-pick]").forEach(btn=>{
    btn.addEventListener("click", ()=>togglePick(btn.dataset.pick, btn));
  });
}

// âœ… ì™„ë£Œ(ì €ì¥ â†’ ì´ë™)
async function handleComplete() {
  const names = getSelectedNames();
  if (!names.length) {
    alert("ì„ íƒëœ ê´€ê´‘ì§€ê°€ ì—†ì–´ìš”.");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/selection/places`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        destination: selectedDestination,
        places: names
      }),
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(`HTTP ${res.status} ${t.slice(0,180)}`);
    }

    // ë‹¤ìŒ í˜ì´ì§€ì—ì„œ ì“°ë„ë¡ ì €ì¥í•´ ë‘ë©´ í¸ë¦¬
    localStorage.setItem("justgo_selected_places", JSON.stringify(names));
    localStorage.setItem("justgo_selected_destination", selectedDestination);

    // âœ… ì €ì¥ ì„±ê³µ ì‹œ í˜ì´ì§€ ì´ë™ (íŒŒì¼ëª… ì •í™•íˆ!)
    window.location.href = "justgofood.html";
  } catch (e) {
    console.error(e);
    alert("ì„ íƒ ì €ì¥ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
  }
}


function placeCardHTML(p){
  const name = p?.name || p?.title || "ì´ë¦„ ë¯¸ìƒ";
  const addr = p?.address || "";
  const img  = p?.image_url || "";
  const thumb= img || "https://picsum.photos/seed/justgo/220/220";
  const url  = p?.naver_url || p?.map_link || ("https://map.naver.com/v5/search/"+encodeURIComponent(name));
  const rating = (p?.rating!=null && !Number.isNaN(Number(p.rating))) ? Number(p.rating).toFixed(1) : "â€“";
  const reviews= (p?.review_count!=null) ? Number(p.review_count).toLocaleString()+"ê°œ" : "ì •ë³´ ì—†ìŒ";

  const picked = selected.has(name);
  return `
    <article class="card">
      <div class="thumb" style="background-image:url('${esc(thumb)}')"></div>
      <div class="body">
        <div class="name">${esc(name)}</div>
        <div class="rate">â˜… ${rating} Â· ë¦¬ë·° ${reviews}</div>
        <div class="meta">${esc(addr)}</div>
        <div class="actions">
          <a href="${esc(url)}" class="map" target="_blank" rel="noreferrer">ì§€ë„</a>
          <button class="pick ${picked?'picked':''}" data-pick="${esc(name)}">${picked?'ì„ íƒë¨':'ì„ íƒ'}</button>
        </div>
      </div>
    </article>
  `;
}

function togglePick(name, btn){
  if(selected.has(name)){ selected.delete(name); }
  else { selected.add(name); }
  btn.classList.toggle("picked", selected.has(name));
  btn.textContent = selected.has(name) ? "ì„ íƒë¨" : "ì„ íƒ";
  updateDoneLabel();
}

function updateDoneLabel(){
  const n = selected.size;
  doneBtn.textContent = n ? `ì™„ë£Œ (ì„ íƒ ${n})` : "ì™„ë£Œ";
}

// ---- ì €ì¥ í˜¸ì¶œ ----
doneBtn.addEventListener("click", async () => {
  const destination    = getDestinationSafe();
  const selectedPlaces = getSelectedPlacesSafe();

  if (!selectedPlaces.length) {
    toast("ì„ íƒëœ ì¥ì†Œê°€ ì—†ì–´ìš”.");
    return;
  }
  if (!destination) {
    alert("ì—¬í–‰ì§€ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/selection/places`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
body: JSON.stringify({
        destination,
        places: selectedPlaces,
        category: "attraction"   // ğŸ”¥ ì¹´í…Œê³ ë¦¬ ëª…ì‹œ
      })
    });

    if (!res.ok) {
      const t = await res.text();
      throw new Error(`HTTP ${res.status}: ${t.slice(0,150)}`);
    }

    const data = await res.json();
    console.log("ì €ì¥ ì„±ê³µ:", data);

    // ë‹¤ìŒ í˜ì´ì§€ì—ì„œë„ ì“°ê²Œ ì €ì¥(ì„ íƒì‚¬í•­)
    localStorage.setItem("justgo_selected_places", JSON.stringify(selectedPlaces));
    localStorage.setItem("justgo_selected_destination", destination);

    toast(`ì €ì¥ ì™„ë£Œ! (${data?.saved_count ?? selectedPlaces.length}ê°œ)`);

    // âœ… 1ì´ˆ í›„ í˜ì´ì§€ ì´ë™
    setTimeout(() => { window.location.href = "justgofood.html"; }, 1000);

  } catch (e) {
    console.error("ì €ì¥ ì‹¤íŒ¨:", e);
    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

document.getElementById("complete-btn").addEventListener("click", () => {
  // âœ… í˜„ì¬ ì„ íƒëœ ì¥ì†Œ ëª©ë¡ ë§Œë“¤ê¸°
  const selectedPlaces = Array.from(selected);

  if (!selectedPlaces.length) {
    alert("ì„ íƒëœ ê´€ê´‘ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  fetch("http://127.0.0.1:8000/api/selection/places", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      destination: selectedDestination,
      places: selectedPlaces
    })
  })
  .then(res => {
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    return res.json();
  })
  .then(data => {
    console.log("ì €ì¥ ì„±ê³µ:", data);

    // âœ… ì €ì¥ ì„±ê³µ í›„ 1ì´ˆ ë’¤ ì´ë™
    setTimeout(() => {
      window.location.href = "justgofood.html";
    }, 1000);
  })
  .catch(err => {
    console.error("ì €ì¥ ì‹¤íŒ¨:", err);
    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  });
});


// ì´ˆê¸°í™”
window.addEventListener("DOMContentLoaded", () => {
  hydrateChips();
  loadPlaces();
});

</script>
</body>
</html>
